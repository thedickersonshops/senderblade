<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Blade Scissor Feint</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --success-color: #10b981;
            --warning-color: #f59e0b;
            --danger-color: #ef4444;
            --dark-bg: #1f2937;
            --light-bg: #f8fafc;
        }
        
        body { background: var(--light-bg); }
        
        .sidebar { 
            position: fixed; top: 0; bottom: 0; left: 0; z-index: 100; 
            padding: 48px 0 0; height: 100vh;
            background: var(--primary-gradient);
            box-shadow: 4px 0 15px rgba(0, 0, 0, 0.1);
            overflow-y: auto;
            overflow-x: hidden;
        }
        
        /* Custom scrollbar for sidebar */
        .sidebar::-webkit-scrollbar {
            width: 6px;
        }
        
        .sidebar::-webkit-scrollbar-track {
            background: rgba(255,255,255,0.1);
            border-radius: 3px;
        }
        
        .sidebar::-webkit-scrollbar-thumb {
            background: rgba(255,255,255,0.3);
            border-radius: 3px;
        }
        
        .sidebar::-webkit-scrollbar-thumb:hover {
            background: rgba(255,255,255,0.5);
        }
        
        .sidebar .nav-link { 
            font-weight: 500; color: rgba(255, 255, 255, 0.8); 
            padding: 0.75rem 1.5rem; margin: 0.2rem 0.5rem; 
            border-radius: 12px; transition: all 0.3s ease;
        }
        
        .sidebar .nav-link:hover { 
            color: #fff; background-color: rgba(255, 255, 255, 0.15);
            transform: translateX(5px);
        }
        
        .sidebar .nav-link.active { 
            color: #fff; background-color: rgba(255, 255, 255, 0.25);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }
        
        main { padding-top: 1.5rem; }
        
        .card {
            border: none;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            border-radius: 16px;
            transition: all 0.3s ease;
            background: white;
        }
        
        .card:hover {
            transform: translateY(-4px);
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
        }
        
        .btn {
            border-radius: 10px;
            font-weight: 500;
            transition: all 0.2s ease;
            padding: 0.6rem 1.2rem;
        }
        
        .btn-primary {
            background: var(--primary-gradient);
            border: none;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
        }
        
        .btn-success {
            background: var(--success-color);
            border: none;
            box-shadow: 0 4px 15px rgba(16, 185, 129, 0.3);
        }
        
        .btn-danger {
            background: var(--danger-color);
            border: none;
            box-shadow: 0 4px 15px rgba(239, 68, 68, 0.3);
        }
        
        .alert {
            border: none;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
        }
        
        .form-control, .form-select {
            border-radius: 10px;
            border: 2px solid #e5e7eb;
            transition: all 0.2s ease;
        }
        
        .form-control:focus, .form-select:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        .badge {
            border-radius: 20px;
            padding: 0.4rem 0.8rem;
            font-weight: 500;
        }
        
        .table {
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
        }
        
        /* Water Splash Loading Animation */
        .water-splash-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(102, 126, 234, 0.95);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            backdrop-filter: blur(10px);
        }
        
        .water-splash {
            width: 120px;
            height: 120px;
            position: relative;
        }
        
        .water-drop {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            background: radial-gradient(circle at 30% 30%, #ffffff, #87ceeb, #4682b4);
            position: relative;
            animation: splash 2s ease-in-out infinite;
            box-shadow: 0 0 30px rgba(70, 130, 180, 0.6);
        }
        
        .water-drop::before {
            content: '';
            position: absolute;
            top: -20px;
            left: 50%;
            transform: translateX(-50%);
            width: 20px;
            height: 30px;
            background: linear-gradient(to bottom, transparent, #87ceeb);
            border-radius: 50% 50% 50% 50% / 60% 60% 40% 40%;
            animation: drop 2s ease-in-out infinite;
        }
        
        .splash-ripple {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 100px;
            height: 100px;
            border: 3px solid rgba(255, 255, 255, 0.6);
            border-radius: 50%;
            animation: ripple 2s ease-out infinite;
        }
        
        .splash-text {
            color: white;
            font-size: 1.2rem;
            font-weight: 600;
            margin-top: 2rem;
            text-align: center;
            animation: pulse 2s ease-in-out infinite;
        }
        
        @keyframes splash {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.2); }
        }
        
        @keyframes drop {
            0% { opacity: 0; transform: translateX(-50%) translateY(-10px); }
            50% { opacity: 1; transform: translateX(-50%) translateY(0px); }
            100% { opacity: 0; transform: translateX(-50%) translateY(10px); }
        }
        
        @keyframes ripple {
            0% { width: 100px; height: 100px; opacity: 1; }
            100% { width: 200px; height: 200px; opacity: 0; }
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 0.7; }
            50% { opacity: 1; }
        }
        
        /* Campaign Status Indicators */
        .campaign-status {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            animation: pulse-dot 2s ease-in-out infinite;
        }
        
        .status-sending .status-dot {
            background: var(--warning-color);
        }
        
        .status-completed .status-dot {
            background: var(--success-color);
        }
        
        .status-failed .status-dot {
            background: var(--danger-color);
        }
        
        @keyframes pulse-dot {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.5; transform: scale(1.2); }
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <div class="row">
            <nav id="sidebar" class="col-md-3 col-lg-2 d-md-block bg-dark sidebar collapse">
                <div class="position-sticky pt-3">
                    <div class="text-center mb-4">
                        <h3 class="text-white">Blade Scissor Feint</h3>
                    </div>
                    <ul class="nav flex-column">
                        <li class="nav-item">
                            <a class="nav-link active" href="#" onclick="loadDashboard()">
                                <i class="fas fa-tachometer-alt me-2"></i> Dashboard
                            </a>
                        </li>
                        
                        <!-- Setup Section -->
                        <li class="nav-item mt-3">
                            <small class="text-muted px-3 d-block">SETUP</small>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#" onclick="loadLists()">
                                <i class="fas fa-list me-2"></i> Email Lists
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#" onclick="loadSmtp()">
                                <i class="fas fa-server me-2"></i> SMTP Servers
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#" onclick="loadProxies()">
                                <i class="fas fa-shield-alt me-2"></i> Proxies
                            </a>
                        </li>
                        
                        <!-- Content Section -->
                        <li class="nav-item mt-3">
                            <small class="text-muted px-3 d-block">CONTENT</small>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#" onclick="loadSpinner()">
                                <i class="fas fa-random me-2"></i> Message Spinner
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#" onclick="loadTemplateManager()">
                                <i class="fas fa-file-alt me-2"></i> Template Manager
                            </a>
                        </li>

                        
                        <!-- Delivery Section -->
                        <li class="nav-item mt-3">
                            <small class="text-muted px-3 d-block">DELIVERY</small>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#" onclick="loadDelivery()">
                                <i class="fas fa-magic me-2"></i> Scissor Feint
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#" onclick="loadSenderDomains()">
                                <i class="fas fa-at me-2"></i> Sender Domains
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#" onclick="loadCampaigns()">
                                <i class="fas fa-paper-plane me-2"></i> Campaigns
                            </a>
                        </li>
                        
                        <!-- Monitoring Section -->
                        <li class="nav-item mt-3">
                            <small class="text-muted px-3 d-block">MONITORING</small>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#" onclick="loadAnalytics()">
                                <i class="fas fa-heartbeat me-2"></i> System Health
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#" onclick="loadActivity()">
                                <i class="fas fa-history me-2"></i> Activity Log
                            </a>
                        </li>
                        
                        <!-- User Section -->
                        <li class="nav-item mt-3">
                            <small class="text-muted px-3 d-block">USER</small>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#" onclick="loadSettings()">
                                <i class="fas fa-cog me-2"></i> Settings
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#" onclick="handleLogout()">
                                <i class="fas fa-sign-out-alt me-2"></i> Logout
                            </a>
                        </li>
                    </ul>
                    
                    <!-- User Info -->
                    <div class="mt-auto p-3 border-top">
                        <div class="text-white" id="userInfo">
                            <i class="fas fa-user me-2"></i>
                            <span id="currentUsername">Loading...</span>
                        </div>
                    </div>
                </div>
            </nav>

            <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4">
                <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                    <h1 id="pageTitle">Dashboard</h1>
                    <div id="pageActions"></div>
                </div>

                <div id="alertContainer"></div>
                <div id="pageContent"></div>
            </main>
        </div>
    </div>
    
    <!-- Water Splash Loading Overlay -->
    <div id="waterSplashOverlay" class="water-splash-overlay">
        <div class="text-center">
            <div class="water-splash">
                <div class="water-drop"></div>
                <div class="splash-ripple"></div>
            </div>
            <div class="splash-text" id="splashText">Sending Campaign...</div>
        </div>
    </div>
    
    <!-- Create Campaign Modal -->
    <div class="modal fade" id="createCampaignModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Create Campaign</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h6>Basic Settings</h6>
                            <div class="mb-3">
                                <label for="campaignName" class="form-label">Campaign Name</label>
                                <input type="text" class="form-control" id="campaignName" name="campaignName" required>
                            </div>
                            <div class="mb-3">
                                <label for="campaignList" class="form-label">Email List</label>
                                <select class="form-select" id="campaignList" name="campaignList" required>
                                    <option value="">Select a list...</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label for="campaignSmtp" class="form-label">SMTP Server</label>
                                <select class="form-select" id="campaignSmtp" name="campaignSmtp" required>
                                    <option value="">Select SMTP server...</option>
                                </select>
                            </div>
                            
                            <div class="mb-3">
                                <label class="form-label">Message Source</label>
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="messageSource" id="useSavedMessage" value="saved" checked onchange="toggleMessageSource()">
                                    <label class="form-check-label" for="useSavedMessage">Use Saved Message from Spinner</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="messageSource" id="useTemplate" value="template" onchange="toggleMessageSource()">
                                    <label class="form-check-label" for="useTemplate">Select from Templates</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="messageSource" id="composeNew" value="compose" onchange="toggleMessageSource()">
                                    <label class="form-check-label" for="composeNew">Compose New Message</label>
                                </div>
                            </div>
                            
                            <!-- Saved Message Preview -->
                            <div id="savedMessagePreview">
                                <div class="mb-3">
                                    <label class="form-label">Saved Message Preview</label>
                                    <div class="card">
                                        <div class="card-body" id="messagePreviewContent">
                                            <small class="text-muted">No saved message found</small>
                                        </div>
                                    </div>
                                    <button type="button" class="btn btn-sm btn-outline-primary mt-2" onclick="editSavedMessage()">Edit Message</button>
                                </div>
                            </div>
                            
                            <!-- Template Selection -->
                            <div id="templateSelection" style="display: none;">
                                <div class="mb-3">
                                    <label for="campaignTemplate" class="form-label">Select Template</label>
                                    <select class="form-select" id="campaignTemplate" onchange="loadTemplatePreview()">
                                        <option value="">-- Select Template --</option>
                                    </select>
                                </div>
                                <div class="mb-3" id="templatePreviewSection" style="display: none;">
                                    <label class="form-label">Template Preview</label>
                                    <div class="card">
                                        <div class="card-body" id="templatePreviewContent">
                                            <small class="text-muted">Select a template to see preview</small>
                                        </div>
                                    </div>
                                    <button type="button" class="btn btn-sm btn-outline-primary mt-2" onclick="editSelectedTemplate()">Edit Template</button>
                                </div>
                            </div>
                            
                            <!-- Compose New Message -->
                            <div id="composeMessageSection" style="display: none;">
                                <div class="mb-3">
                                    <label for="messageFormat" class="form-label">Message Format</label>
                                    <select class="form-select" id="messageFormat" name="messageFormat" onchange="toggleMessageEditor()">
                                        <option value="text">Plain Text</option>
                                        <option value="html">HTML Code</option>
                                        <option value="visual">Visual Editor</option>
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <label for="composeSubject" class="form-label">Subject</label>
                                    <input type="text" class="form-control" id="composeSubject" name="composeSubject" placeholder="Enter your email subject">
                                </div>
                                <div class="mb-3">
                                    <label for="composeBody" class="form-label">Message Content</label>
                                    <textarea class="form-control" id="composeBody" name="composeBody" rows="6" placeholder="Compose your message here with {first_name} variables" oninput="updateCampaignPreview()"></textarea>
                                </div>
                                
                                <div class="mb-3">
                                    <button type="button" class="btn btn-outline-info btn-sm" onclick="previewCampaignContent()">Preview Spinning</button>
                                    <div class="alert alert-info mt-2 py-2" style="font-size: 0.85em;">
                                        <i class="fas fa-info-circle me-1"></i><strong>Note:</strong> Signature preview works perfectly with Plain Text and HTML formats. Visual Editor signatures display correctly in actual emails.
                                    </div>
                                    <div id="campaignPreview" class="mt-2" style="display: none;">
                                        <div class="card">
                                            <div class="card-header py-1">
                                                <small>Preview with Auto-Spinning (2 Variations)</small>
                                            </div>
                                            <div class="card-body py-2" id="campaignPreviewContent"></div>
                                        </div>
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <div class="row">
                                        <div class="col-6">
                                            <div class="form-check form-switch">
                                                <input class="form-check-input" type="checkbox" id="enableMessageSpinning" checked>
                                                <label class="form-check-label" for="enableMessageSpinning">Enable Spinning</label>
                                            </div>
                                        </div>
                                        <div class="col-6">
                                            <div class="form-check form-switch">
                                                <input class="form-check-input" type="checkbox" id="enableMessageEncryption">
                                                <label class="form-check-label" for="enableMessageEncryption">Enable Encryption</label>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="mb-3">
                                <label for="messagePriority" class="form-label">Message Priority</label>
                                <select class="form-select" id="messagePriority" name="messagePriority">
                                    <option value="normal">Normal</option>
                                    <option value="high">High Priority</option>
                                    <option value="urgent">Urgent</option>
                                </select>
                            </div>
                            
                            <h6 class="mt-4">Sender Settings</h6>
                            <div class="mb-3">
                                <label for="campaignFromName" class="form-label">From Name</label>
                                <div class="input-group">
                                    <input type="text" class="form-control" id="campaignFromName" name="campaignFromName" placeholder="Override SMTP from name">
                                    <button class="btn btn-outline-secondary" type="button" onclick="generateRandomName()" title="Generate Random Name">
                                        <i class="fas fa-random"></i>
                                    </button>
                                </div>
                                <small class="text-muted">Leave blank to use SMTP server's from name</small>
                            </div>
                            <div class="mb-3">
                                <label for="campaignFromEmail" class="form-label">From Email</label>
                                <div class="input-group">
                                    <input type="email" class="form-control" id="campaignFromEmail" name="campaignFromEmail" placeholder="Override SMTP from email">
                                    <button class="btn btn-outline-secondary" type="button" onclick="generateRandomEmail()" title="Generate Random Email">
                                        <i class="fas fa-random"></i>
                                    </button>
                                </div>
                                <small class="text-muted">Leave blank to use SMTP server's from email</small>
                            </div>
                            <div class="mb-3">
                                <label for="campaignReplyTo" class="form-label">Reply-To Email</label>
                                <div class="input-group">
                                    <input type="email" class="form-control" id="campaignReplyTo" name="campaignReplyTo" placeholder="Optional reply-to address">
                                    <button class="btn btn-outline-secondary" type="button" onclick="generateRandomReplyTo()" title="Generate Random Email">
                                        <i class="fas fa-random"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <h6>Delivery Options</h6>
                            <div class="mb-3">
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="enableIpRotation" checked>
                                    <label class="form-check-label" for="enableIpRotation">Enable IP Rotation</label>
                                </div>
                                <small class="text-muted">Use different proxies for better delivery</small>
                            </div>
                            

                            
                            <div class="mb-3">
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="enableAutoSpin" checked>
                                    <label class="form-check-label" for="enableAutoSpin">Auto-Spin Content</label>
                                </div>
                                <small class="text-muted">Automatically vary words for better deliverability (50% of spinnable words)</small>
                            </div>
                            
                            <div class="mb-3">
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="useRandomEmail" checked>
                                    <label class="form-check-label" for="useRandomEmail">
                                        <strong>📧 Random Email Generation</strong>
                                    </label>
                                </div>
                                <small class="text-muted">Toggle ON: Uses random emails | Toggle OFF: Uses SMTP server's actual email</small>
                            </div>
                            
                            <div class="mb-3" id="randomEmailOptions">
                                <label class="form-label">Random Email Mode</label>
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="randomMode" id="randomUsername" value="username_only" checked>
                                    <label class="form-check-label" for="randomUsername">
                                        <strong>Random Username</strong> (Safest)
                                    </label>
                                    <small class="text-muted d-block">info@fayehallcookies.online, news247@fayehallcookies.online</small>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="randomMode" id="randomBoth" value="username_subdomain">
                                    <label class="form-check-label" for="randomBoth">
                                        <strong>Random Username + Subdomain</strong> (Medium)
                                    </label>
                                    <small class="text-muted d-block">info@mail.fayehallcookies.online, abc123@news.fayehallcookies.online</small>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="randomMode" id="randomSubdomain" value="subdomain_only">
                                    <label class="form-check-label" for="randomSubdomain">
                                        <strong>Random Subdomain</strong> (Highest Variation)
                                    </label>
                                    <small class="text-muted d-block">info@mail.fayehallcookies.online, info@campaigns.fayehallcookies.online</small>
                                </div>
                            </div>
                            
                            <div class="mb-3">
                                <label class="form-label">Delivery Mode</label>
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="deliveryMode" id="normalMode" value="normal" checked onchange="toggleDeliveryMode()">
                                    <label class="form-check-label" for="normalMode">Normal Mode</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="deliveryMode" id="stealthMode" value="stealth" onchange="toggleDeliveryMode()">
                                    <label class="form-check-label" for="stealthMode">🥷 Stealth Mode</label>
                                </div>
                            </div>
                            
                            <!-- Normal Mode Options -->
                            <div id="normalModeOptions">
                                <div class="mb-3">
                                    <label for="sendDelay" class="form-label">Send Delay (seconds)</label>
                                    <select class="form-select" id="sendDelay" name="sendDelay">
                                        <option value="1-3">Fast (1-3 seconds)</option>
                                        <option value="3-7" selected>Medium (3-7 seconds)</option>
                                        <option value="5-10">Slow (5-10 seconds)</option>
                                    </select>
                                </div>
                            </div>
                            
                            <!-- Stealth Mode Options -->
                            <div id="stealthModeOptions" style="display: none;">
                                <div class="mb-3">
                                    <label for="specialDelivery" class="form-label">Special Delivery Options</label>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="useSmtpRotation" checked>
                                        <label class="form-check-label" for="useSmtpRotation">SMTP Server Rotation</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="useRandomHeaders" checked>
                                        <label class="form-check-label" for="useRandomHeaders">Random Email Headers</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="useInboxOptimization" checked>
                                        <label class="form-check-label" for="useInboxOptimization">🎯 Inbox Optimization</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="useAdvancedThrottling" checked>
                                        <label class="form-check-label" for="useAdvancedThrottling">Advanced Throttling</label>
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <label for="specialDelay" class="form-label">Advanced Delay Range</label>
                                    <select class="form-select" id="specialDelay" name="specialDelay">
                                        <option value="2-8">Conservative (2-8 seconds)</option>
                                        <option value="5-15" selected>Balanced (5-15 seconds)</option>
                                        <option value="10-30">Aggressive (10-30 seconds)</option>
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <label for="batchSize" class="form-label">Batch Size</label>
                                    <select class="form-select" id="batchSize" name="batchSize">
                                        <option value="10">Small (10 emails/batch)</option>
                                        <option value="25" selected>Medium (25 emails/batch)</option>
                                        <option value="50">Large (50 emails/batch)</option>
                                    </select>
                                    <small class="text-muted">Pause between batches for better delivery</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="saveCampaign()">Create Campaign</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Create List Modal -->
    <div class="modal fade" id="createListModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Create Email List</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="listName" class="form-label">List Name</label>
                        <input type="text" class="form-control" id="listName" name="listName" required>
                    </div>
                    <div class="mb-3">
                        <label for="listDescription" class="form-label">Description</label>
                        <textarea class="form-control" id="listDescription" name="listDescription" rows="3"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="saveList()">Create List</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Upload Contacts Modal -->
    <div class="modal fade" id="uploadContactsModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Upload Contacts</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="contactsFile" class="form-label">CSV File</label>
                        <input type="file" class="form-control" id="contactsFile" name="contactsFile" accept=".csv,.txt">
                        <small class="form-text text-muted">Format: email,first_name,last_name</small>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Or Generate Random Emails</label>
                        <div class="row">
                            <div class="col-md-4">
                                <input type="number" class="form-control" id="randomCount" name="randomCount" placeholder="Count" value="10">
                            </div>
                            <div class="col-md-4">
                                <select class="form-select" id="randomType" name="randomType">
                                    <option value="random">Random</option>
                                    <option value="domain">Custom Domain</option>
                                    <option value="subdomain">Random Subdomain</option>
                                </select>
                            </div>
                            <div class="col-md-4">
                                <input type="text" class="form-control" id="customDomain" name="customDomain" placeholder="domain.com">
                            </div>
                        </div>
                        <button type="button" class="btn btn-secondary mt-2" onclick="generateRandomEmails()">Generate Random Emails</button>
                    </div>
                    <input type="hidden" id="uploadListId" value="">
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="uploadContacts()">Upload</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Add SMTP Modal -->
    <div class="modal fade" id="addSmtpModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Add SMTP Server</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="smtpProvider" class="form-label">Email Provider (Optional)</label>
                        <select class="form-select" id="smtpProvider" onchange="fillSmtpProvider()">
                            <option value="">Custom SMTP Server</option>
                            <option value="gmail">Gmail</option>
                            <option value="outlook">Outlook/Hotmail</option>
                            <option value="yahoo">Yahoo</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="smtpName" class="form-label">Server Name</label>
                        <input type="text" class="form-control" id="smtpName" name="smtpName" required>
                    </div>
                    <div class="mb-3">
                        <label for="smtpHost" class="form-label">Host</label>
                        <input type="text" class="form-control" id="smtpHost" name="smtpHost" required>
                    </div>
                    <div class="mb-3">
                        <label for="smtpPort" class="form-label">Port</label>
                        <input type="number" class="form-control" id="smtpPort" name="smtpPort" required value="587">
                    </div>
                    <div class="mb-3">
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="requireAuth" checked onchange="toggleAuthFields()">
                            <label class="form-check-label" for="requireAuth">Requires Authentication</label>
                        </div>
                        <small class="text-muted">Uncheck for open relays or local servers</small>
                    </div>
                    <div id="authFields">
                        <div class="mb-3">
                            <label for="smtpUsername" class="form-label">Username</label>
                            <input type="text" class="form-control" id="smtpUsername" name="smtpUsername">
                        </div>
                        <div class="mb-3">
                            <label for="smtpPassword" class="form-label">Password</label>
                            <input type="password" class="form-control" id="smtpPassword" name="smtpPassword">
                        </div>
                    </div>


                    <div class="mb-3">
                        <label class="form-label">Advanced Options</label>
                        <div class="form-check">
                            <input type="checkbox" class="form-check-input" id="useRandomSenders">
                            <label class="form-check-label" for="useRandomSenders">
                                Use random sender addresses for each email
                            </label>
                        </div>
                        <div class="form-check">
                            <input type="checkbox" class="form-check-input" id="useRandomSubdomains">
                            <label class="form-check-label" for="useRandomSubdomains">
                                Use random subdomains
                            </label>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="testSmtp()">Test Connection</button>
                    <button type="button" class="btn btn-success" onclick="saveSmtp()">Save Server</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Proxy Modal -->
    <div class="modal fade" id="addProxyModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Add Proxy</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="proxyHost" class="form-label">Host</label>
                        <input type="text" class="form-control" id="proxyHost" name="proxyHost" required>
                    </div>
                    <div class="mb-3">
                        <label for="proxyPort" class="form-label">Port</label>
                        <input type="number" class="form-control" id="proxyPort" name="proxyPort" required value="1080">
                    </div>
                    <div class="mb-3">
                        <label for="proxyType" class="form-label">Type</label>
                        <select class="form-select" id="proxyType" name="proxyType">
                            <option value="http">HTTP</option>
                            <option value="socks4">SOCKS4</option>
                            <option value="socks5">SOCKS5</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="proxyUsername" class="form-label">Username</label>
                        <input type="text" class="form-control" id="proxyUsername" name="proxyUsername">
                    </div>
                    <div class="mb-3">
                        <label for="proxyPassword" class="form-label">Password</label>
                        <input type="password" class="form-control" id="proxyPassword" name="proxyPassword">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="testProxy()">Test Connection</button>
                    <button type="button" class="btn btn-success" onclick="saveProxy()">Save Proxy</button>
                </div>
            </div>
        </div>
    </div>    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="js/spinner.js"></script>
    <script src="js/campaign_spinner.js"></script>
    <script src="js/dashboard_fix.js"></script>
    <script>
        // API calls
        async function api(endpoint, method = 'GET', data = null) {
            const options = {
                method,
                headers: { 'Content-Type': 'application/json' },
                credentials: 'include'
            };
            if (data) options.body = JSON.stringify(data);
            
            const response = await fetch(`http://localhost:5001/api${endpoint}`, options);
            return await response.json();
        }

        // Alert function
        function showAlert(message, type = 'info') {
            const alertContainer = document.getElementById('alertContainer');
            const alertElement = document.createElement('div');
            alertElement.className = `alert alert-${type} alert-dismissible fade show`;
            alertElement.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            alertContainer.appendChild(alertElement);
            setTimeout(() => alertElement.remove(), 5000);
        }
        
        // Water Splash Loading Functions
        function showWaterSplash(message = 'Processing...') {
            const overlay = document.getElementById('waterSplashOverlay');
            const text = document.getElementById('splashText');
            text.textContent = message;
            overlay.style.display = 'flex';
        }
        
        function hideWaterSplash() {
            const overlay = document.getElementById('waterSplashOverlay');
            overlay.style.display = 'none';
        }
        
        // Enhanced API calls with loading
        async function apiWithLoading(endpoint, method = 'GET', data = null, loadingMessage = 'Processing...') {
            showWaterSplash(loadingMessage);
            try {
                const result = await api(endpoint, method, data);
                hideWaterSplash();
                return result;
            } catch (error) {
                hideWaterSplash();
                throw error;
            }
        }

        // Random generators
        function generateRandomEmail() {
            const enableRandomSubdomains = document.getElementById('enableRandomSubdomains').checked;
            
            if (enableRandomSubdomains) {
                const randomEmail = getRandomSubdomain();
                if (randomEmail) {
                    document.getElementById('campaignFromEmail').value = randomEmail;
                    return;
                }
            }
            
            // Fallback to regular random email
            const names = ['john', 'jane', 'mike', 'sarah', 'david', 'lisa', 'chris', 'anna'];
            const domains = ['gmail.com', 'yahoo.com', 'hotmail.com', 'outlook.com'];
            const name = names[Math.floor(Math.random() * names.length)];
            const num = Math.floor(Math.random() * 999) + 1;
            const domain = domains[Math.floor(Math.random() * domains.length)];
            document.getElementById('campaignFromEmail').value = `${name}${num}@${domain}`;
        }
        
        function updateRandomPreview() {
            const randomMode = document.querySelector('input[name="randomMode"]:checked').value;
            const preview = document.getElementById('randomPreview');
            const example = document.getElementById('randomExample');
            
            let exampleText = '';
            
            switch(randomMode) {
                case 'username_only':
                    exampleText = 'info@fayehallcookies.online, news247@fayehallcookies.online, marketing@fayehallcookies.online';
                    break;
                case 'username_subdomain':
                    exampleText = 'info@mail.fayehallcookies.online, abc123@news.fayehallcookies.online, team@campaigns.fayehallcookies.online';
                    break;
                case 'subdomain_only':
                    exampleText = 'info@mail.fayehallcookies.online, info@campaigns.fayehallcookies.online, info@newsletter.fayehallcookies.online';
                    break;
            }
            
            example.textContent = exampleText;
            preview.style.display = 'block';
            
            // Auto-hide after 3 seconds
            setTimeout(() => {
                preview.style.display = 'none';
            }, 3000);
        }
        
        // Initialize random email toggle
        document.addEventListener('DOMContentLoaded', function() {
            // Set up toggle functionality when modal is shown
            const createCampaignModal = document.getElementById('createCampaignModal');
            if (createCampaignModal) {
                createCampaignModal.addEventListener('shown.bs.modal', function() {
                    const useRandomEmailToggle = document.getElementById('useRandomEmail');
                    const randomEmailOptions = document.getElementById('randomEmailOptions');
                    
                    if (useRandomEmailToggle && randomEmailOptions) {
                        useRandomEmailToggle.addEventListener('change', function() {
                            if (this.checked) {
                                randomEmailOptions.style.display = 'block';
                            } else {
                                randomEmailOptions.style.display = 'none';
                            }
                        });
                        
                        // Initial state
                        if (useRandomEmailToggle.checked) {
                            randomEmailOptions.style.display = 'block';
                        } else {
                            randomEmailOptions.style.display = 'none';
                        }
                    }
                });
            }
        });

        function generateRandomName() {
            const firstNames = ['John', 'Jane', 'Mike', 'Sarah', 'David', 'Lisa', 'Chris', 'Anna'];
            const lastNames = ['Smith', 'Johnson', 'Brown', 'Davis', 'Miller', 'Wilson'];
            const first = firstNames[Math.floor(Math.random() * firstNames.length)];
            const last = lastNames[Math.floor(Math.random() * lastNames.length)];
            document.getElementById('campaignFromName').value = `${first} ${last}`;
        }

        function generateRandomReplyTo() {
            const names = ['support', 'info', 'contact', 'hello', 'team'];
            const domains = ['gmail.com', 'yahoo.com', 'hotmail.com'];
            const name = names[Math.floor(Math.random() * names.length)];
            const num = Math.floor(Math.random() * 99) + 1;
            const domain = domains[Math.floor(Math.random() * domains.length)];
            document.getElementById('campaignReplyTo').value = `${name}${num}@${domain}`;
        }





        function fillSmtpProvider() {
            const provider = document.getElementById('smtpProvider').value;
            const configs = {
                gmail: { host: 'smtp.gmail.com', port: 587 },
                outlook: { host: 'smtp.office365.com', port: 587 },
                yahoo: { host: 'smtp.mail.yahoo.com', port: 587 }
            };
            
            if (configs[provider]) {
                document.getElementById('smtpHost').value = configs[provider].host;
                document.getElementById('smtpPort').value = configs[provider].port;
            }
        }

        // Dashboard
        async function loadDashboard() {
            document.getElementById('pageTitle').textContent = 'Dashboard';
            document.getElementById('pageActions').innerHTML = '';
            
            const lists = await api('/lists');
            const smtp = await api('/smtp');
            const proxies = await api('/proxies');
            const campaigns = await api('/campaigns');
            
            document.getElementById('pageContent').innerHTML = `
                <div class="row">
                    <div class="col-md-3">
                        <div class="card">
                            <div class="card-body">
                                <h5>Email Lists</h5>
                                <h2>${lists.data ? lists.data.length : 0}</h2>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card">
                            <div class="card-body">
                                <h5>SMTP Servers</h5>
                                <h2>${smtp.data ? smtp.data.length : 0}</h2>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card">
                            <div class="card-body">
                                <h5>Proxies</h5>
                                <h2>${proxies.data ? proxies.data.length : 0}</h2>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card">
                            <div class="card-body">
                                <h5>Campaigns</h5>
                                <h2>${campaigns.data ? campaigns.data.length : 0}</h2>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        // Lists
        async function loadLists() {
            document.getElementById('pageTitle').textContent = 'Email Lists';
            document.getElementById('pageActions').innerHTML = '<button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#createListModal">Create List</button>';
            
            const result = await api('/lists');
            const lists = result.data || [];
            
            let html = '';
            if (lists.length === 0) {
                html = '<div class="alert alert-info">No lists found. Create your first list.</div>';
            } else {
                html = `
                    <table class="table">
                        <thead>
                            <tr><th>Name</th><th>Contacts</th><th>Actions</th></tr>
                        </thead>
                        <tbody>
                            ${lists.map(list => `
                                <tr>
                                    <td>${list.name}</td>
                                    <td>${list.contact_count}</td>
                                    <td>
                                        <button class="btn btn-sm btn-primary" onclick="viewList(${list.id})">View</button>
                                        <button class="btn btn-sm btn-danger" onclick="deleteList(${list.id})">Delete</button>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                `;
            }
            document.getElementById('pageContent').innerHTML = html;
        }

        async function saveList() {
            const name = document.getElementById('listName').value;
            const description = document.getElementById('listDescription').value;
            
            if (!name) {
                showAlert('Please enter a list name', 'danger');
                return;
            }
            
            const result = await api('/lists', 'POST', { name, description });
            
            if (result.success) {
                showAlert('List created successfully', 'success');
                bootstrap.Modal.getInstance(document.getElementById('createListModal')).hide();
                loadLists();
            } else {
                showAlert(result.message, 'danger');
            }
        }

        async function viewList(listId) {
            const list = await api(`/lists/${listId}`);
            const contacts = await api(`/lists/${listId}/contacts`);
            
            document.getElementById('pageTitle').textContent = list.data.name;
            document.getElementById('pageActions').innerHTML = `
                <button class="btn btn-primary" onclick="showUploadModal(${listId})">Upload Contacts</button>
            `;
            
            let html = `<h5>Contacts (${list.data.contact_count})</h5>`;
            
            if (contacts.data && contacts.data.length > 0) {
                html += `
                    <table class="table">
                        <thead>
                            <tr><th>Email</th><th>First Name</th><th>Last Name</th></tr>
                        </thead>
                        <tbody>
                            ${contacts.data.map(contact => `
                                <tr>
                                    <td>${contact.email}</td>
                                    <td>${contact.first_name || '-'}</td>
                                    <td>${contact.last_name || '-'}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                `;
            } else {
                html += '<div class="alert alert-info">No contacts found. Upload contacts to get started.</div>';
            }
            
            document.getElementById('pageContent').innerHTML = html;
        }

        function showUploadModal(listId) {
            document.getElementById('uploadListId').value = listId;
            new bootstrap.Modal(document.getElementById('uploadContactsModal')).show();
        }

        async function generateRandomEmails() {
            const count = document.getElementById('randomCount').value;
            const type = document.getElementById('randomType').value;
            const domain = document.getElementById('customDomain').value;
            const listId = document.getElementById('uploadListId').value;
            
            if (!count || count < 1) {
                showAlert('Please enter a valid count', 'danger');
                return;
            }
            
            if (type === 'domain' && !domain) {
                showAlert('Please enter a custom domain', 'danger');
                return;
            }
            
            const result = await api('/generate/emails', 'POST', { count: parseInt(count), type, domain });
            
            if (result.success) {
                const addResult = await api(`/lists/${listId}/contacts`, 'POST', { contacts: result.data });
                
                if (addResult.success) {
                    showAlert(`${addResult.added_count} random emails generated and added successfully`, 'success');
                    bootstrap.Modal.getInstance(document.getElementById('uploadContactsModal')).hide();
                    viewList(listId);
                } else {
                    showAlert(addResult.message, 'danger');
                }
            } else {
                showAlert(result.message, 'danger');
            }
        }

        async function uploadContacts() {
            const listId = document.getElementById('uploadListId').value;
            const fileInput = document.getElementById('contactsFile');
            
            if (!fileInput.files[0]) {
                showAlert('Please select a file or generate random emails', 'danger');
                return;
            }
            
            const file = fileInput.files[0];
            const reader = new FileReader();
            
            reader.onload = async function(e) {
                const content = e.target.result;
                const lines = content.split('\n').filter(line => line.trim());
                const contacts = [];
                
                lines.forEach(line => {
                    const parts = line.split(',');
                    const email = parts[0]?.trim();
                    if (email && email.includes('@')) {
                        contacts.push({
                            email: email,
                            first_name: parts[1]?.trim() || '',
                            last_name: parts[2]?.trim() || ''
                        });
                    }
                });
                
                if (contacts.length === 0) {
                    showAlert('No valid contacts found', 'danger');
                    return;
                }
                
                const result = await api(`/lists/${listId}/contacts`, 'POST', { contacts });
                
                if (result.success) {
                    showAlert(`${result.added_count} contacts added successfully`, 'success');
                    bootstrap.Modal.getInstance(document.getElementById('uploadContactsModal')).hide();
                    viewList(listId);
                } else {
                    showAlert(result.message, 'danger');
                }
            };
            
            reader.readAsText(file);
        }

        async function deleteList(listId) {
            if (!confirm('Are you sure you want to delete this list?')) return;
            
            const result = await api(`/lists/${listId}`, 'DELETE');
            
            if (result.success) {
                showAlert('List deleted successfully', 'success');
                loadLists();
            } else {
                showAlert(result.message, 'danger');
            }
        }

        // SMTP
        async function loadSmtp() {
            document.getElementById('pageTitle').textContent = 'SMTP Servers';
            document.getElementById('pageActions').innerHTML = '<button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addSmtpModal">Add SMTP Server</button>';
            
            const result = await api('/smtp');
            const servers = result.data || [];
            
            let html = '';
            if (servers.length === 0) {
                html = '<div class="alert alert-info">No SMTP servers found. Add your first server.</div>';
            } else {
                html = `
                    <table class="table">
                        <thead>
                            <tr><th>Name</th><th>Host</th><th>Username</th><th>From Email</th><th>Actions</th></tr>
                        </thead>
                        <tbody>
                            ${servers.map(server => `
                                <tr>
                                    <td>${server.name}</td>
                                    <td>${server.host}:${server.port}</td>
                                    <td>${server.username}</td>
                                    <td>${server.from_email}</td>
                                    <td>
                                        <button class="btn btn-sm btn-danger" onclick="deleteSmtp(${server.id})">Delete</button>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                `;
            }
            document.getElementById('pageContent').innerHTML = html;
        }

        async function testSmtp() {
            const host = document.getElementById('smtpHost').value;
            const port = document.getElementById('smtpPort').value;
            const requireAuth = document.getElementById('requireAuth').checked;
            const username = requireAuth ? document.getElementById('smtpUsername').value : '';
            const password = requireAuth ? document.getElementById('smtpPassword').value : '';
            
            if (!host || !port) {
                showAlert('Please fill in host and port', 'danger');
                return;
            }
            
            if (requireAuth && (!username || !password)) {
                showAlert('Username and password required when authentication is enabled', 'danger');
                return;
            }
            
            const result = await api('/smtp/test', 'POST', { host, port, username, password, require_auth: requireAuth });
            
            if (result.success) {
                showAlert('SMTP connection successful', 'success');
            } else {
                showAlert(result.message, 'danger');
            }
        }

        function toggleAuthFields() {
            const requireAuth = document.getElementById('requireAuth').checked;
            const authFields = document.getElementById('authFields');
            
            if (requireAuth) {
                authFields.style.display = 'block';
                document.getElementById('smtpUsername').required = true;
                document.getElementById('smtpPassword').required = true;
            } else {
                authFields.style.display = 'none';
                document.getElementById('smtpUsername').required = false;
                document.getElementById('smtpPassword').required = false;
            }
        }
        
        async function saveSmtp() {
            const name = document.getElementById('smtpName').value;
            const host = document.getElementById('smtpHost').value;
            const port = document.getElementById('smtpPort').value;
            const requireAuth = document.getElementById('requireAuth').checked;
            const username = requireAuth ? document.getElementById('smtpUsername').value : '';
            const password = requireAuth ? document.getElementById('smtpPassword').value : '';
            const from_email = '';
            const from_name = '';
            
            if (!name || !host || !port) {
                showAlert('Please fill in name, host, and port', 'danger');
                return;
            }
            
            if (requireAuth && (!username || !password)) {
                showAlert('Username and password required when authentication is enabled', 'danger');
                return;
            }
            
            const result = await api('/smtp', 'POST', {
                name, host, port: parseInt(port), username, password, from_email, from_name, require_auth: requireAuth
            });
            
            if (result.success) {
                showAlert('SMTP server added successfully', 'success');
                bootstrap.Modal.getInstance(document.getElementById('addSmtpModal')).hide();
                loadSmtp();
            } else {
                showAlert(result.message, 'danger');
            }
        }

        async function deleteSmtp(serverId) {
            if (!confirm('Are you sure you want to delete this SMTP server?')) return;
            
            const result = await api(`/smtp/${serverId}`, 'DELETE');
            
            if (result.success) {
                showAlert('SMTP server deleted successfully', 'success');
                loadSmtp();
            } else {
                showAlert(result.message, 'danger');
            }
        }

        // Proxies
        async function loadProxies() {
            document.getElementById('pageTitle').textContent = 'Proxies';
            document.getElementById('pageActions').innerHTML = '<button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addProxyModal">Add Proxy</button>';
            
            const result = await api('/proxies');
            const proxies = result.data || [];
            
            let html = '';
            if (proxies.length === 0) {
                html = '<div class="alert alert-info">No proxies found. Add your first proxy.</div>';
            } else {
                html = `
                    <table class="table">
                        <thead>
                            <tr><th>Host</th><th>Port</th><th>Type</th><th>Username</th><th>Actions</th></tr>
                        </thead>
                        <tbody>
                            ${proxies.map(proxy => `
                                <tr>
                                    <td>${proxy.host}</td>
                                    <td>${proxy.port}</td>
                                    <td>${proxy.proxy_type}</td>
                                    <td>${proxy.username || '-'}</td>
                                    <td>
                                        <button class="btn btn-sm btn-danger" onclick="deleteProxy(${proxy.id})">Delete</button>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                `;
            }
            document.getElementById('pageContent').innerHTML = html;
        }

        async function testProxy() {
            const host = document.getElementById('proxyHost').value;
            const port = document.getElementById('proxyPort').value;
            const username = document.getElementById('proxyUsername').value;
            const password = document.getElementById('proxyPassword').value;
            const proxy_type = document.getElementById('proxyType').value;
            
            if (!host || !port) {
                showAlert('Host and port are required', 'danger');
                return;
            }
            
            const result = await api('/proxy/test', 'POST', { host, port, username, password, proxy_type });
            
            if (result.success) {
                showAlert(`Proxy connection successful. Your IP: ${result.data.ip}`, 'success');
            } else {
                showAlert(result.message, 'danger');
            }
        }

        async function saveProxy() {
            const host = document.getElementById('proxyHost').value;
            const port = document.getElementById('proxyPort').value;
            const username = document.getElementById('proxyUsername').value;
            const password = document.getElementById('proxyPassword').value;
            const proxy_type = document.getElementById('proxyType').value;
            
            if (!host || !port) {
                showAlert('Host and port are required', 'danger');
                return;
            }
            
            const result = await api('/proxies', 'POST', {
                host, port: parseInt(port), username, password, proxy_type
            });
            
            if (result.success) {
                showAlert('Proxy added successfully', 'success');
                bootstrap.Modal.getInstance(document.getElementById('addProxyModal')).hide();
                loadProxies();
            } else {
                showAlert(result.message, 'danger');
            }
        }

        async function deleteProxy(proxyId) {
            if (!confirm('Are you sure you want to delete this proxy?')) return;
            
            const result = await api(`/proxies/${proxyId}`, 'DELETE');
            
            if (result.success) {
                showAlert('Proxy deleted successfully', 'success');
                loadProxies();
            } else {
                showAlert(result.message, 'danger');
            }
        }

        // Toggle message source
        function toggleMessageSource() {
            const useSaved = document.getElementById('useSavedMessage').checked;
            const useTemplate = document.getElementById('useTemplate').checked;
            const composeNew = document.getElementById('composeNew').checked;
            
            const savedPreview = document.getElementById('savedMessagePreview');
            const templateSelection = document.getElementById('templateSelection');
            const composeSection = document.getElementById('composeMessageSection');
            
            // Hide all sections first
            savedPreview.style.display = 'none';
            templateSelection.style.display = 'none';
            composeSection.style.display = 'none';
            
            if (useSaved) {
                savedPreview.style.display = 'block';
                loadSavedMessagePreview();
            } else if (useTemplate) {
                templateSelection.style.display = 'block';
                loadTemplatesList();
            } else if (composeNew) {
                composeSection.style.display = 'block';
            }
        }
        
        // Load saved message preview
        function loadSavedMessagePreview() {
            const savedMessage = localStorage.getItem('currentMessage');
            const previewContent = document.getElementById('messagePreviewContent');
            
            if (savedMessage) {
                const message = JSON.parse(savedMessage);
                let preview = '';
                
                // Process spinning and variables for preview
                let processedSubject = message.subject || '';
                let processedContent = message.content || '';
                
                // Apply spinning if enabled
                if (message.enableSpinner) {
                    processedSubject = applyCampaignSpinning(processedSubject);
                    processedContent = applyCampaignSpinning(processedContent);
                }
                
                // Replace variables with sample data
                processedSubject = processedSubject.replace(/{first_name}/g, 'John');
                processedSubject = processedSubject.replace(/{email}/g, 'john@example.com');
                processedContent = processedContent.replace(/{first_name}/g, 'John');
                processedContent = processedContent.replace(/{email}/g, 'john@example.com');
                
                if (processedSubject) {
                    preview += `<strong>Subject:</strong> ${processedSubject}<br><br>`;
                }
                
                if (processedContent) {
                    const shortContent = processedContent.length > 200 ? 
                        processedContent.substring(0, 200) + '...' : processedContent;
                    
                    if (message.format === 'html' || message.format === 'visual') {
                        preview += `<div style="border: 1px solid #ddd; padding: 10px; background: #f9f9f9;">${shortContent}</div>`;
                    } else {
                        preview += `<pre style="white-space: pre-wrap; background: #f9f9f9; padding: 10px; border: 1px solid #ddd;">${shortContent}</pre>`;
                    }
                    
                    preview += `<br><small class="text-muted">Format: ${message.format || 'text'} | Spinning: ${message.enableSpinner ? 'On' : 'Off'} | Encryption: ${message.enableEncryption ? 'On' : 'Off'}</small>`;
                } else {
                    preview = '<small class="text-muted">No message content found</small>';
                }
                
                previewContent.innerHTML = preview;
            } else {
                previewContent.innerHTML = '<small class="text-muted">No saved message found. Create one in Message Spinner.</small>';
            }
        }
        
        // Edit saved message
        function editSavedMessage() {
            // Switch to compose mode and load saved message
            document.getElementById('composeNew').checked = true;
            toggleMessageSource();
            
            const savedMessage = localStorage.getItem('currentMessage');
            if (savedMessage) {
                const message = JSON.parse(savedMessage);
                
                if (message.format) {
                    document.getElementById('messageFormat').value = message.format;
                }
                if (message.subject) {
                    document.getElementById('composeSubject').value = message.subject;
                }
                if (message.content) {
                    document.getElementById('composeBody').value = message.content;
                }
                if (message.enableSpinner !== undefined) {
                    document.getElementById('enableMessageSpinning').checked = message.enableSpinner;
                }
                if (message.enableEncryption !== undefined) {
                    document.getElementById('enableMessageEncryption').checked = message.enableEncryption;
                }
            }
        }
        
        // Toggle message editor
        function toggleMessageEditor() {
            const format = document.getElementById('messageFormat').value;
            const textarea = document.getElementById('composeBody');
            
            if (format === 'html') {
                textarea.placeholder = 'Enter HTML content with variables like {first_name}';
            } else if (format === 'visual') {
                textarea.placeholder = 'Visual editor content will be generated automatically';
            } else {
                textarea.placeholder = 'Enter plain text with variables like {first_name}';
            }
        }
        
        // Load templates list for campaign
        async function loadTemplatesList() {
            try {
                const response = await api('/spinner/templates');
                const templateSelect = document.getElementById('campaignTemplate');
                
                templateSelect.innerHTML = '<option value="">-- Select Template --</option>';
                
                if (response.success && response.data) {
                    response.data.forEach(template => {
                        templateSelect.innerHTML += `<option value="${template.id}">${template.name}</option>`;
                    });
                }
            } catch (error) {
                console.error('Error loading templates:', error);
            }
        }
        
        // Load template preview
        async function loadTemplatePreview() {
            const templateId = document.getElementById('campaignTemplate').value;
            const previewSection = document.getElementById('templatePreviewSection');
            const previewContent = document.getElementById('templatePreviewContent');
            
            if (!templateId) {
                previewSection.style.display = 'none';
                return;
            }
            
            try {
                const response = await api('/spinner/templates');
                if (response.success && response.data) {
                    const template = response.data.find(t => t.id == templateId);
                    
                    if (template) {
                        let preview = '';
                        
                        if (template.subject) {
                            preview += `<strong>Subject:</strong> ${template.subject}<br><br>`;
                        }
                        
                        if (template.content) {
                            const shortContent = template.content.length > 200 ? 
                                template.content.substring(0, 200) + '...' : template.content;
                            
                            // Detect format
                            let format = 'text';
                            if (template.content.includes('max-width: 600px') || template.content.includes('font-family: Arial')) {
                                format = 'visual';
                            } else if (template.content.includes('<')) {
                                format = 'html';
                            }
                            
                            if (format === 'html' || format === 'visual') {
                                preview += `<div style="border: 1px solid #ddd; padding: 10px; background: #f9f9f9;">${shortContent}</div>`;
                            } else {
                                preview += `<pre style="white-space: pre-wrap; background: #f9f9f9; padding: 10px; border: 1px solid #ddd;">${shortContent}</pre>`;
                            }
                            
                            preview += `<br><small class="text-muted">Format: ${format}</small>`;
                        }
                        
                        previewContent.innerHTML = preview;
                        previewSection.style.display = 'block';
                    }
                }
            } catch (error) {
                console.error('Error loading template preview:', error);
            }
        }
        
        // Edit selected template
        function editSelectedTemplate() {
            const templateId = document.getElementById('campaignTemplate').value;
            if (!templateId) return;
            
            // Switch to compose mode and load template
            document.getElementById('composeNew').checked = true;
            toggleMessageSource();
            
            // Load template data into compose form
            loadTemplateIntoComposer(templateId);
        }
        
        // Load template into composer
        async function loadTemplateIntoComposer(templateId) {
            try {
                const response = await api('/spinner/templates');
                if (response.success && response.data) {
                    const template = response.data.find(t => t.id == templateId);
                    
                    if (template) {
                        // Detect format
                        let format = 'text';
                        if (template.content.includes('max-width: 600px') || template.content.includes('font-family: Arial')) {
                            format = 'visual';
                        } else if (template.content.includes('<')) {
                            format = 'html';
                        }
                        
                        // Set format and content
                        document.getElementById('messageFormat').value = format;
                        document.getElementById('composeSubject').value = template.subject || '';
                        document.getElementById('composeBody').value = template.content || '';
                        
                        // Update editor
                        toggleMessageEditor();
                    }
                }
            } catch (error) {
                console.error('Error loading template into composer:', error);
            }
        }
        
        // Toggle delivery mode
        function toggleDeliveryMode() {
            const normalMode = document.getElementById('normalMode').checked;
            const normalOptions = document.getElementById('normalModeOptions');
            const stealthOptions = document.getElementById('stealthModeOptions');
            
            if (normalMode) {
                normalOptions.style.display = 'block';
                stealthOptions.style.display = 'none';
            } else {
                normalOptions.style.display = 'none';
                stealthOptions.style.display = 'block';
            }
        }

        // Campaigns
        async function loadCampaigns() {
            document.getElementById('pageTitle').textContent = 'Campaigns';
            document.getElementById('pageActions').innerHTML = '<button class="btn btn-primary" onclick="showCreateCampaignModal()">Create Campaign</button>';
            
            const result = await api('/campaigns');
            const campaigns = result.data || [];
            
            let html = '';
            if (campaigns.length === 0) {
                html = '<div class="alert alert-info">No campaigns found. Create your first campaign.</div>';
            } else {
                html = `
                    <table class="table">
                        <thead>
                            <tr><th>Name</th><th>List</th><th>SMTP</th><th>Status</th><th>Progress</th><th>Actions</th></tr>
                        </thead>
                        <tbody>
                            ${campaigns.map(campaign => `
                                <tr>
                                    <td>${campaign.name}</td>
                                    <td>${campaign.list_name}</td>
                                    <td>${campaign.smtp_name}</td>
                                    <td>
                                        <div class="campaign-status status-${campaign.status}">
                                            <div class="status-dot"></div>
                                            <span class="badge bg-${getStatusColor(campaign.status)}">${campaign.status}</span>
                                        </div>
                                    </td>
                                    <td>
                                        <div>${campaign.sent_emails}/${campaign.total_emails}</div>
                                        <small class="text-muted">${getStatusMessage(campaign)}</small>
                                    </td>
                                    <td>
                                        <div class="d-flex gap-1">
                                            <button class="btn btn-info btn-sm" onclick="viewCampaign(${campaign.id})" title="View Campaign">
                                                <i class="fas fa-eye"></i>
                                            </button>
                                            <button class="btn btn-warning btn-sm" onclick="editCampaign(${campaign.id})" title="Edit Campaign">
                                                <i class="fas fa-edit"></i>
                                            </button>
                                            ${campaign.status === 'draft' ? `
                                                <button class="btn btn-success btn-sm" onclick="sendCampaign(${campaign.id})" title="Send Campaign">
                                                    <i class="fas fa-paper-plane"></i>
                                                </button>
                                            ` : ''}
                                            <button class="btn btn-danger btn-sm" onclick="deleteCampaign(${campaign.id})" title="Delete Campaign">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                `;
            }
            document.getElementById('pageContent').innerHTML = html;
        }

        function getStatusColor(status) {
            switch(status) {
                case 'draft': return 'secondary';
                case 'sending': return 'warning';
                case 'completed': return 'success';
                case 'failed': return 'danger';
                default: return 'secondary';
            }
        }
        
        function getStatusMessage(campaign) {
            switch(campaign.status) {
                case 'draft': return 'Ready to send';
                case 'sending': 
                    if (campaign.sent_emails === 0) {
                        return 'Starting to send emails...';
                    } else {
                        return `Sending emails (${Math.round((campaign.sent_emails/campaign.total_emails)*100)}% complete)`;
                    }
                case 'completed': return `Campaign completed successfully`;
                case 'failed': return 'Campaign failed - check logs';
                default: return '';
            }
        }

        async function showCreateCampaignModal() {
            // Load saved message from spinner if available
            const savedMessage = localStorage.getItem('currentMessage');
            
            const lists = await api('/lists');
            const smtp = await api('/smtp');
            
            const listSelect = document.getElementById('campaignList');
            listSelect.innerHTML = '<option value="">Select a list...</option>';
            if (lists.data) {
                lists.data.forEach(list => {
                    listSelect.innerHTML += `<option value="${list.id}">${list.name} (${list.contact_count} contacts)</option>`;
                });
            }
            
            const smtpSelect = document.getElementById('campaignSmtp');
            smtpSelect.innerHTML = '<option value="">Select SMTP server...</option>';
            if (smtp.data) {
                smtp.data.forEach(server => {
                    smtpSelect.innerHTML += `<option value="${server.id}">${server.name} (${server.username})</option>`;
                });
            }
            
            // Initialize message source toggle
            toggleMessageSource();
            
            new bootstrap.Modal(document.getElementById('createCampaignModal')).show();
            
            // Setup random email toggle after modal is shown
            setTimeout(() => {
                setupRandomEmailToggle();
            }, 100);
        }
        
        function setupRandomEmailToggle() {
            const useRandomEmailToggle = document.getElementById('useRandomEmail');
            const randomEmailOptions = document.getElementById('randomEmailOptions');
            
            if (useRandomEmailToggle && randomEmailOptions) {
                useRandomEmailToggle.addEventListener('change', function() {
                    if (this.checked) {
                        randomEmailOptions.style.display = 'block';
                    } else {
                        randomEmailOptions.style.display = 'none';
                    }
                });
                
                // Initial state
                if (useRandomEmailToggle.checked) {
                    randomEmailOptions.style.display = 'block';
                } else {
                    randomEmailOptions.style.display = 'none';
                }
            }
        }

        async function saveCampaign() {
            const name = document.getElementById('campaignName').value;
            const list_id = document.getElementById('campaignList').value;
            const smtp_id = document.getElementById('campaignSmtp').value;
            
            // Get message content based on source
            const messageSource = document.querySelector('input[name="messageSource"]:checked').value;
            let subject, body;
            
            if (messageSource === 'saved') {
                const savedMessage = localStorage.getItem('currentMessage');
                if (savedMessage) {
                    const message = JSON.parse(savedMessage);
                    subject = message.subject || '';
                    body = message.content || '';
                } else {
                    showAlert('No saved message found. Please create one in Message Spinner.', 'danger');
                    return;
                }
            } else if (messageSource === 'template') {
                const templateId = document.getElementById('campaignTemplate').value;
                if (!templateId) {
                    showAlert('Please select a template.', 'danger');
                    return;
                }
                
                // Get template data
                try {
                    const response = await api('/spinner/templates');
                    if (response.success && response.data) {
                        const template = response.data.find(t => t.id == templateId);
                        if (template) {
                            subject = template.subject || '';
                            body = template.content || '';
                        } else {
                            showAlert('Selected template not found.', 'danger');
                            return;
                        }
                    }
                } catch (error) {
                    showAlert('Error loading template data.', 'danger');
                    return;
                }
            } else {
                subject = document.getElementById('composeSubject').value;
                body = document.getElementById('composeBody').value;
            }
            
            // Get sender settings
            const from_name = document.getElementById('campaignFromName').value;
            const from_email = document.getElementById('campaignFromEmail').value;
            const reply_to = document.getElementById('campaignReplyTo').value;
            const priority = document.getElementById('messagePriority').value;
            
            // Get delivery settings
            const enable_ip_rotation = document.getElementById('enableIpRotation').checked;
            const random_mode = document.querySelector('input[name="randomMode"]:checked').value;
            const enable_auto_spin = document.getElementById('enableAutoSpin').checked;
            const delivery_mode = document.querySelector('input[name="deliveryMode"]:checked').value;
            
            if (!name || !list_id || !smtp_id || !subject || !body) {
                showAlert('Please fill in all required fields', 'danger');
                return;
            }
            
            const campaignData = {
                name, 
                list_id: parseInt(list_id), 
                smtp_id: parseInt(smtp_id), 
                subject, 
                body,
                from_name,
                from_email,
                reply_to,
                priority,
                enable_ip_rotation,
                random_mode: document.querySelector('input[name="randomMode"]:checked').value,
                enable_auto_spin,
                delivery_mode,
                use_random_email: document.getElementById('useRandomEmail') ? document.getElementById('useRandomEmail').checked : true
            };
            
            try {
                const result = await apiWithLoading('/campaigns', 'POST', campaignData, '🎨 Creating Campaign...');
                
                if (result.success) {
                    showAlert('✨ Campaign created successfully!', 'success');
                    bootstrap.Modal.getInstance(document.getElementById('createCampaignModal')).hide();
                    loadCampaigns();
                } else {
                    showAlert('❌ ' + result.message, 'danger');
                }
            } catch (error) {
                showAlert('❌ Failed to create campaign', 'danger');
            }
        }

        async function sendCampaign(campaignId) {
            if (!confirm('Are you sure you want to send this campaign? This cannot be undone.')) return;
            
            try {
                // Set campaign sending state
                if (window.setCampaignSending) {
                    window.setCampaignSending(true);
                }
                
                const result = await apiWithLoading(`/campaigns/${campaignId}/send`, 'POST', null, '💧 Sending Campaign... 📧');
                
                if (result.success) {
                    showAlert('🎉 Campaign started! Switching to live monitoring...', 'success');
                    
                    // Immediately switch to activity log
                    setTimeout(() => {
                        loadActivity();
                        // Start live monitoring
                        if (!isUnifiedAutoRefresh) {
                            toggleUnifiedAutoRefresh();
                        }
                    }, 1000);
                    
                    // Auto-refresh campaigns every 5 seconds while sending
                    const refreshInterval = setInterval(async () => {
                        const campaigns = await api('/campaigns');
                        const campaign = campaigns.data?.find(c => c.id === campaignId);
                        
                        if (campaign && campaign.status !== 'sending') {
                            clearInterval(refreshInterval);
                            if (window.setCampaignSending) {
                                window.setCampaignSending(false);
                            }
                            showAlert('📧 Campaign completed!', 'success');
                        }
                    }, 5000);
                } else {
                    if (window.setCampaignSending) {
                        window.setCampaignSending(false);
                    }
                    showAlert('❌ ' + result.message, 'danger');
                }
            } catch (error) {
                if (window.setCampaignSending) {
                    window.setCampaignSending(false);
                }
                showAlert('❌ Failed to send campaign', 'danger');
            }
        }

        async function viewCampaign(campaignId) {
            try {
                const result = await api(`/campaigns`);
                const campaign = result.data?.find(c => c.id === campaignId);
                
                if (!campaign) {
                    showAlert('Campaign not found', 'danger');
                    return;
                }
                
                const modalHTML = `
                    <div class="modal fade" id="viewCampaignModal" tabindex="-1">
                        <div class="modal-dialog modal-lg">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title">📧 Campaign Details</h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                </div>
                                <div class="modal-body">
                                    <div class="row">
                                        <div class="col-md-6">
                                            <h6>📋 Basic Information</h6>
                                            <p><strong>Name:</strong> ${campaign.name}</p>
                                            <p><strong>List:</strong> ${campaign.list_name}</p>
                                            <p><strong>SMTP:</strong> ${campaign.smtp_name}</p>
                                            <p><strong>Status:</strong> <span class="badge bg-${getStatusColor(campaign.status)}">${campaign.status}</span></p>
                                            <p><strong>Progress:</strong> ${campaign.sent_emails}/${campaign.total_emails}</p>
                                        </div>
                                        <div class="col-md-6">
                                            <h6>📧 Message Content</h6>
                                            <p><strong>Subject:</strong> ${campaign.subject}</p>
                                            <div class="border p-2" style="max-height: 200px; overflow-y: auto; background: #f8f9fa;">
                                                ${campaign.body.replace(/\n/g, '<br>')}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                                    ${campaign.status === 'draft' ? `
                                        <button type="button" class="btn btn-warning" onclick="editCampaign(${campaign.id}); bootstrap.Modal.getInstance(document.getElementById('viewCampaignModal')).hide();">Edit</button>
                                        <button type="button" class="btn btn-success" onclick="sendCampaign(${campaign.id}); bootstrap.Modal.getInstance(document.getElementById('viewCampaignModal')).hide();">Send</button>
                                    ` : ''}
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                document.body.insertAdjacentHTML('beforeend', modalHTML);
                new bootstrap.Modal(document.getElementById('viewCampaignModal')).show();
                
                // Clean up modal after hiding
                document.getElementById('viewCampaignModal').addEventListener('hidden.bs.modal', function() {
                    this.remove();
                });
                
            } catch (error) {
                showAlert('Error loading campaign details', 'danger');
            }
        }
        
        async function editCampaign(campaignId) {
            try {
                const result = await api(`/campaigns`);
                const campaign = result.data?.find(c => c.id === campaignId);
                
                if (!campaign) {
                    showAlert('Campaign not found', 'danger');
                    return;
                }
                
                if (campaign.status !== 'draft') {
                    showAlert('Only draft campaigns can be edited', 'warning');
                    return;
                }
                
                // Show create campaign modal with existing data
                await showCreateCampaignModal();
                
                // Fill form with existing data
                setTimeout(() => {
                    document.getElementById('campaignName').value = campaign.name;
                    document.getElementById('campaignList').value = campaign.list_id;
                    document.getElementById('campaignSmtp').value = campaign.smtp_id;
                    
                    // Set compose mode and fill content
                    document.getElementById('composeNew').checked = true;
                    toggleMessageSource();
                    
                    setTimeout(() => {
                        document.getElementById('composeSubject').value = campaign.subject;
                        document.getElementById('composeBody').value = campaign.body;
                    }, 200);
                    
                    // Change modal title and button
                    document.querySelector('#createCampaignModal .modal-title').textContent = 'Edit Campaign';
                    const saveButton = document.querySelector('#createCampaignModal .btn-primary');
                    saveButton.textContent = 'Update Campaign';
                    saveButton.onclick = () => updateCampaign(campaignId);
                }, 300);
                
            } catch (error) {
                showAlert('Error loading campaign for editing', 'danger');
            }
        }
        
        async function updateCampaign(campaignId) {
            const name = document.getElementById('campaignName').value;
            const list_id = document.getElementById('campaignList').value;
            const smtp_id = document.getElementById('campaignSmtp').value;
            const subject = document.getElementById('composeSubject').value;
            const body = document.getElementById('composeBody').value;
            
            if (!name || !list_id || !smtp_id || !subject || !body) {
                showAlert('Please fill in all required fields', 'danger');
                return;
            }
            
            try {
                const result = await apiWithLoading(`/campaigns/${campaignId}`, 'PUT', {
                    name, list_id: parseInt(list_id), smtp_id: parseInt(smtp_id), subject, body
                }, 'Updating campaign...');
                
                if (result.success) {
                    showAlert('Campaign updated successfully!', 'success');
                    bootstrap.Modal.getInstance(document.getElementById('createCampaignModal')).hide();
                    loadCampaigns();
                } else {
                    showAlert('Error updating campaign: ' + result.message, 'danger');
                }
            } catch (error) {
                showAlert('Error updating campaign', 'danger');
            }
        }

        async function deleteCampaign(campaignId) {
            if (!confirm('Are you sure you want to delete this campaign?')) return;
            
            const result = await api(`/campaigns/${campaignId}`, 'DELETE');
            
            if (result.success) {
                showAlert('Campaign deleted successfully', 'success');
                loadCampaigns();
            } else {
                showAlert(result.message, 'danger');
            }
        }

        // Template Manager function
        function loadTemplateManager() {
            document.getElementById('pageTitle').textContent = 'Template Manager';
            document.getElementById('pageActions').innerHTML = `
                <button class="btn btn-primary" onclick="showCreateTemplateModal()">
                    <i class="fas fa-plus me-1"></i>Create New Template
                </button>
            `;
            
            // Reset to first page when loading template manager
            resetTemplatePage();
            
            // Add template manager specific CSS
            addTemplateManagerCSS();
            
            // Load template management interface
            loadTemplateManagementInterface();
        }
        
        function addTemplateManagerCSS() {
            // Check if CSS already added
            if (document.getElementById('templateManagerCSS')) return;
            
            const style = document.createElement('style');
            style.id = 'templateManagerCSS';
            style.textContent = `
                .template-card {
                    transition: all 0.3s ease;
                    border: none;
                    border-radius: 15px;
                    overflow: hidden;
                    position: relative;
                }
                .template-card:hover {
                    transform: translateY(-8px);
                    box-shadow: 0 15px 35px rgba(0,0,0,0.1);
                }
                .template-actions {
                    position: absolute;
                    top: 15px;
                    right: 15px;
                    opacity: 0;
                    transition: opacity 0.3s ease;
                    z-index: 10;
                }
                .template-card:hover .template-actions {
                    opacity: 1;
                }
                .template-card .card-header {
                    border-bottom: none;
                    padding: 1.25rem;
                }
                .template-card .card-body {
                    padding: 1.5rem;
                }
                .template-card .card-footer {
                    padding: 1.25rem;
                    border-top: 1px solid #e9ecef;
                }
            `;
            document.head.appendChild(style);
            
            // Force refresh the page content after CSS is loaded
            setTimeout(() => {
                const pageContent = document.getElementById('pageContent');
                if (pageContent && pageContent.innerHTML.includes('template-card')) {
                    // CSS is loaded, templates should display properly now
                    console.log('Template Manager CSS loaded successfully');
                }
            }, 100);
        }
        
        // Template pagination variables
        window.templatePage = window.templatePage || 1;
        window.templatesPerPage = 4;
        
        async function loadTemplateManagementInterface() {
            try {
                showWaterSplash('Loading templates...');
                const response = await fetch('/api/spinner/templates?' + Date.now());
                const result = await response.json();
                hideWaterSplash();
                
                if (!result.success) {
                    throw new Error(result.message || 'Failed to load templates');
                }
                
                const templates = result.data || [];
                console.log('Templates loaded for manager:', templates);
                
                let html = '';
                
                if (templates.length === 0) {
                    html = `
                        <div class="row justify-content-center">
                            <div class="col-md-8">
                                <div class="card border-0 shadow-sm">
                                    <div class="card-body text-center py-5">
                                        <div class="mb-4">
                                            <i class="fas fa-file-alt" style="font-size: 4rem; color: #6c757d;"></i>
                                        </div>
                                        <h4 class="card-title mb-3">No Templates Found</h4>
                                        <p class="card-text text-muted mb-4">
                                            Create your first template to get started with professional email campaigns.
                                            Templates help you save time and maintain consistency across your campaigns.
                                        </p>
                                        <button class="btn btn-primary btn-lg" onclick="showCreateTemplateModal()">
                                            <i class="fas fa-plus me-2"></i>Create Your First Template
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                } else {
                    // Calculate pagination
                    const totalPages = Math.ceil(templates.length / window.templatesPerPage);
                    const startIndex = (window.templatePage - 1) * window.templatesPerPage;
                    const endIndex = startIndex + window.templatesPerPage;
                    const displayTemplates = templates.slice(startIndex, endIndex);
                    
                    html = `
                        <div class="container-fluid">
                            <!-- Pagination Info -->
                            <div class="row mb-3">
                                <div class="col-12">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div class="text-muted">
                                            <i class="fas fa-file-alt me-1"></i>
                                            Showing ${startIndex + 1}-${Math.min(endIndex, templates.length)} of ${templates.length} templates
                                        </div>
                                        <div class="text-muted">
                                            Page ${window.templatePage} of ${totalPages}
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Template Grid -->
                            <div class="row g-4 justify-content-center">
                                ${displayTemplates.map(template => {
                                    const shortSubject = (template.subject || 'No subject').length > 35 ? 
                                        (template.subject || 'No subject').substring(0, 35) + '...' : 
                                        (template.subject || 'No subject');
                                    
                                    return `
                                    <div class="col-md-6 col-lg-6">
                                        <div class="card template-card h-100 shadow-sm">
                                            <div class="template-actions">
                                                <button class="btn btn-sm btn-outline-primary me-1" onclick="editTemplate(${template.id})" title="Edit">
                                                    <i class="fas fa-edit"></i>
                                                </button>
                                                <button class="btn btn-sm btn-outline-warning me-1" onclick="renameTemplate(${template.id})" title="Rename">
                                                    <i class="fas fa-tag"></i>
                                                </button>
                                                <button class="btn btn-sm btn-outline-danger" onclick="deleteTemplate(${template.id})" title="Delete">
                                                    <i class="fas fa-trash"></i>
                                                </button>
                                            </div>
                                            <div class="card-header bg-gradient" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                                                <h6 class="card-title mb-0">
                                                    <i class="fas fa-file-alt me-2"></i>${template.name}
                                                </h6>
                                            </div>
                                            <div class="card-body p-3">
                                                <div class="mb-2">
                                                    <small class="text-primary fw-bold">📧 Subject:</small><br>
                                                    <span class="text-dark" style="font-size: 0.9rem;">${shortSubject}</span>
                                                </div>
                                                
                                                <div class="mb-3">
                                                    <small class="text-muted">
                                                        <i class="fas fa-calendar-alt me-1"></i>
                                                        ${new Date(template.created_at).toLocaleDateString()}
                                                    </small>
                                                </div>
                                            </div>
                                            <div class="card-footer bg-white border-top p-2">
                                                <div class="d-flex gap-1">
                                                    <button class="btn btn-success btn-sm flex-fill" onclick="useTemplateInCampaign(${template.id})">
                                                        <i class="fas fa-paper-plane me-1"></i>Use
                                                    </button>
                                                    <button class="btn btn-info btn-sm" onclick="previewTemplate(${template.id})" title="Preview">
                                                        <i class="fas fa-eye"></i>
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    `;
                                }).join('')}
                            </div>
                            
                            <!-- Pagination Controls -->
                            ${totalPages > 1 ? `
                                <div class="row mt-4">
                                    <div class="col-12">
                                        <nav aria-label="Template pagination">
                                            <ul class="pagination justify-content-center">
                                                <!-- First Page -->
                                                <li class="page-item ${window.templatePage === 1 ? 'disabled' : ''}">
                                                    <button class="page-link" onclick="goToTemplatePage(1)" ${window.templatePage === 1 ? 'disabled' : ''}>
                                                        <i class="fas fa-angle-double-left me-1"></i>First
                                                    </button>
                                                </li>
                                                
                                                <!-- Previous Page -->
                                                <li class="page-item ${window.templatePage === 1 ? 'disabled' : ''}">
                                                    <button class="page-link" onclick="goToTemplatePage(${window.templatePage - 1})" ${window.templatePage === 1 ? 'disabled' : ''}>
                                                        <i class="fas fa-angle-left me-1"></i>Previous
                                                    </button>
                                                </li>
                                                
                                                <!-- Page Numbers -->
                                                ${Array.from({length: Math.min(5, totalPages)}, (_, i) => {
                                                    let pageNum;
                                                    if (totalPages <= 5) {
                                                        pageNum = i + 1;
                                                    } else if (window.templatePage <= 3) {
                                                        pageNum = i + 1;
                                                    } else if (window.templatePage >= totalPages - 2) {
                                                        pageNum = totalPages - 4 + i;
                                                    } else {
                                                        pageNum = window.templatePage - 2 + i;
                                                    }
                                                    
                                                    return `
                                                        <li class="page-item ${pageNum === window.templatePage ? 'active' : ''}">
                                                            <button class="page-link" onclick="goToTemplatePage(${pageNum})">${pageNum}</button>
                                                        </li>
                                                    `;
                                                }).join('')}
                                                
                                                <!-- Next Page -->
                                                <li class="page-item ${window.templatePage === totalPages ? 'disabled' : ''}">
                                                    <button class="page-link" onclick="goToTemplatePage(${window.templatePage + 1})" ${window.templatePage === totalPages ? 'disabled' : ''}>
                                                        Next<i class="fas fa-angle-right ms-1"></i>
                                                    </button>
                                                </li>
                                                
                                                <!-- Last Page -->
                                                <li class="page-item ${window.templatePage === totalPages ? 'disabled' : ''}">
                                                    <button class="page-link" onclick="goToTemplatePage(${totalPages})" ${window.templatePage === totalPages ? 'disabled' : ''}>
                                                        Last<i class="fas fa-angle-double-right ms-1"></i>
                                                    </button>
                                                </li>
                                            </ul>
                                        </nav>
                                    </div>
                                </div>
                            ` : ''}
                        </div>
                    `;
                }
                
                document.getElementById('pageContent').innerHTML = html;
                
            } catch (error) {
                hideWaterSplash();
                document.getElementById('pageContent').innerHTML = `
                    <div class="row justify-content-center">
                        <div class="col-md-8">
                            <div class="alert alert-danger text-center">
                                <i class="fas fa-exclamation-triangle fa-2x mb-3"></i>
                                <h4>Error Loading Templates</h4>
                                <p class="mb-3">${error.message}</p>
                                <button class="btn btn-primary" onclick="loadTemplateManagementInterface()">
                                    <i class="fas fa-redo me-1"></i>Try Again
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }
        }
        
        function showCreateTemplateModal() {
            // Create simple modal with working form
            const modalHTML = `
                <div class="modal fade" id="quickTemplateModal" tabindex="-1">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">Create Template</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <div class="mb-3">
                                    <label class="form-label">Name *</label>
                                    <input type="text" class="form-control" id="quickName" required>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Subject</label>
                                    <input type="text" class="form-control" id="quickSubject">
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Content *</label>
                                    <textarea class="form-control" id="quickContent" rows="5" required></textarea>
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                <button type="button" class="btn btn-primary" onclick="saveQuickTemplate()">Save</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', modalHTML);
            new bootstrap.Modal(document.getElementById('quickTemplateModal')).show();
        }
        
        function saveQuickTemplate() {
            const name = document.getElementById('quickName').value.trim();
            const subject = document.getElementById('quickSubject').value.trim();
            const content = document.getElementById('quickContent').value.trim();
            
            if (!name || !content) {
                showAlert('Name and content are required', 'warning');
                return;
            }
            
            saveTemplateDirectly({ name, subject, content, description: '' });
        }
        
        async function saveTemplateDirectly(templateData) {
            try {
                const result = await apiWithLoading('/spinner/templates', 'POST', templateData, 'Creating template...');
                
                if (result.success) {
                    showAlert('Template created successfully!', 'success');
                    // Close modal if it exists
                    const modal = document.getElementById('quickTemplateModal');
                    if (modal) {
                        bootstrap.Modal.getInstance(modal)?.hide();
                        modal.remove();
                    }
                    resetTemplatePage();
                    loadTemplateManagementInterface();
                } else {
                    showAlert('Error creating template: ' + result.message, 'danger');
                }
            } catch (error) {
                showAlert('Error creating template: ' + error.message, 'danger');
            }
        }
        
        // Template Manager saveTemplate - different from Message Spinner saveTemplate
        function saveTemplateFromManager() {
            console.log('Template Manager save called');
            showAlert('Use the modal form to create templates', 'info');
        }
        
        async function editTemplate(templateId) {
            try {
                const response = await api(`/spinner/templates/${templateId}`);
                
                if (response.success) {
                    const template = response.data;
                    
                    // Show modal with existing data
                    showCreateTemplateModal();
                    
                    // Use prompt-based editing in logical order
                    const newName = prompt('📝 Edit Template Name:', template.name);
                    if (!newName || !newName.trim()) return;
                    
                    const newDescription = prompt('📄 Edit Description:', template.description || '');
                    
                    const newSubject = prompt('📧 Edit Email Subject:', template.subject || '');
                    
                    const newContent = prompt('✍️ Edit Email Content:', template.content);
                    if (!newContent || !newContent.trim()) {
                        showAlert('Content cannot be empty', 'warning');
                        return;
                    }
                    
                    // Save directly
                    try {
                        const result = await apiWithLoading(`/spinner/templates/${template.id}`, 'PUT', {
                            name: newName.trim(),
                            description: (newDescription || '').trim(),
                            subject: (newSubject || '').trim(),
                            content: newContent.trim()
                        }, 'Updating template...');
                        
                        if (result.success) {
                            showAlert('Template updated successfully!', 'success');
                            loadTemplateManagementInterface();
                        } else {
                            showAlert('Error updating template: ' + result.message, 'danger');
                        }
                    } catch (error) {
                        showAlert('Error updating template: ' + error.message, 'danger');
                    }
                } else {
                    showAlert('Error loading template: ' + response.message, 'danger');
                }
            } catch (error) {
                showAlert('Error loading template: ' + error.message, 'danger');
            }
        }
        
        async function deleteTemplate(templateId) {
            if (!confirm('Are you sure you want to delete this template? This action cannot be undone.')) {
                return;
            }
            
            try {
                const result = await apiWithLoading(`/spinner/templates/${templateId}`, 'DELETE', null, 'Deleting template...');
                
                if (result.success) {
                    showAlert('Template deleted successfully!', 'success');
                    loadTemplateManagementInterface();
                } else {
                    showAlert('Error deleting template: ' + result.message, 'danger');
                }
            } catch (error) {
                showAlert('Error deleting template: ' + error.message, 'danger');
            }
        }
        
        async function renameTemplate(templateId) {
            const newName = prompt('Enter new template name:');
            if (!newName || !newName.trim()) {
                return;
            }
            
            try {
                // Get current template data
                const response = await api(`/spinner/templates/${templateId}`);
                
                if (response.success) {
                    const template = response.data;
                    template.name = newName.trim();
                    
                    const updateResult = await apiWithLoading(`/spinner/templates/${templateId}`, 'PUT', template, 'Renaming template...');
                    
                    if (updateResult.success) {
                        showAlert('Template renamed successfully!', 'success');
                        loadTemplateManagementInterface();
                    } else {
                        showAlert('Error renaming template: ' + updateResult.message, 'danger');
                    }
                } else {
                    showAlert('Error loading template: ' + response.message, 'danger');
                }
            } catch (error) {
                showAlert('Error renaming template: ' + error.message, 'danger');
            }
        }
        
        async function previewTemplate(templateId) {
            try {
                const response = await api(`/spinner/templates/${templateId}`);
                
                if (response.success) {
                    const template = response.data;
                    
                    // Create preview modal if it doesn't exist
                    if (!document.getElementById('previewTemplateModal')) {
                        const modalHTML = `
                            <div class="modal fade" id="previewTemplateModal" tabindex="-1">
                                <div class="modal-dialog modal-lg">
                                    <div class="modal-content">
                                        <div class="modal-header">
                                            <h5 class="modal-title">Template Preview</h5>
                                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                        </div>
                                        <div class="modal-body" id="previewContent">
                                        </div>
                                        <div class="modal-footer">
                                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `;
                        document.body.insertAdjacentHTML('beforeend', modalHTML);
                    }
                    
                    const previewHtml = `
                        <div class="mb-3">
                            <h6>Template Name:</h6>
                            <p class="fw-bold">${template.name}</p>
                        </div>
                        <div class="mb-3">
                            <h6>Description:</h6>
                            <p>${template.description || 'No description'}</p>
                        </div>
                        <div class="mb-3">
                            <h6>Subject:</h6>
                            <p class="fw-bold">${template.subject || 'No subject'}</p>
                        </div>
                        <div class="mb-3">
                            <h6>Content:</h6>
                            <div class="border p-3" style="background: #f8f9fa; max-height: 400px; overflow-y: auto;">
                                ${template.content.replace(/\n/g, '<br>')}
                            </div>
                        </div>
                    `;
                    
                    document.getElementById('previewContent').innerHTML = previewHtml;
                    new bootstrap.Modal(document.getElementById('previewTemplateModal')).show();
                } else {
                    showAlert('Error loading template preview: ' + response.message, 'danger');
                }
            } catch (error) {
                showAlert('Error loading template preview: ' + error.message, 'danger');
            }
        }
        
        function useTemplateInCampaign(templateId) {
            // Store template ID and redirect to campaigns
            localStorage.setItem('selectedTemplateId', templateId);
            showAlert('Template selected! Creating campaign...', 'success');
            
            // Load campaigns and show create modal
            setTimeout(() => {
                loadCampaigns();
                setTimeout(() => {
                    showCreateCampaignModal();
                    // Auto-select template option
                    document.getElementById('useTemplate').checked = true;
                    toggleMessageSource();
                    
                    // Set the template in dropdown
                    setTimeout(() => {
                        const templateSelect = document.getElementById('campaignTemplate');
                        if (templateSelect) {
                            templateSelect.value = templateId;
                            loadTemplatePreview();
                        }
                    }, 500);
                }, 500);
            }, 1000);
        }
        
        function goToTemplatePage(page) {
            window.templatePage = page;
            loadTemplateManagementInterface();
        }
        
        function resetTemplatePage() {
            window.templatePage = 1;
        }
        
        // Placeholder functions for advanced features
        // loadSpinner function is now defined in spinner.js



        function loadDelivery() {
            document.getElementById('pageTitle').textContent = 'Scissor Feint';
            document.getElementById('pageActions').innerHTML = '';
            document.getElementById('pageContent').innerHTML = `
                <div class="alert alert-success">
                    <h5>Scissor Feint Delivery System</h5>
                    <p>Advanced features automatically enabled:</p>
                    <ul>
                        <li><strong>SMTP Rotation</strong> - Rotates through all your SMTP servers</li>
                        <li><strong>Special Headers</strong> - Microsoft Outlook compatible headers for better delivery</li>
                        <li><strong>Throttling</strong> - Random delays between emails (2-8 seconds)</li>
                        <li><strong>Message Spinning</strong> - Content variation for each email</li>
                    </ul>
                    <p>These features work automatically when sending campaigns!</p>
                </div>
            `;
        }

        function loadSenderDomains() {
            document.getElementById('pageTitle').textContent = 'Sender Domains';
            document.getElementById('pageActions').innerHTML = '<button class="btn btn-primary" onclick="showAddDomainModal()">Add Domain</button>';
            
            // Load existing domains
            loadDomainsList();
        }
        
        async function loadDomainsList() {
            try {
                const domains = JSON.parse(localStorage.getItem('senderDomains') || '[]');
                
                let html = '';
                
                if (domains.length === 0) {
                    html = `
                        <div class="alert alert-info">
                            <h5>📧 Sender Domains Configuration</h5>
                            <p>Configure domains for random subdomain generation:</p>
                            <ul>
                                <li><strong>Random Subdomains</strong> - Generate emails like news@domain.com, marketing@domain.com</li>
                                <li><strong>Better Deliverability</strong> - Spread reputation across multiple subdomains</li>
                                <li><strong>Professional Appearance</strong> - Use branded subdomains for campaigns</li>
                            </ul>
                            <p>Add your first domain to get started!</p>
                        </div>
                    `;
                } else {
                    html = `
                        <div class="row mb-4">
                            <div class="col-md-12">
                                <div class="card">
                                    <div class="card-header">
                                        <h5>📧 Configured Domains</h5>
                                    </div>
                                    <div class="card-body">
                                        <div class="table-responsive">
                                            <table class="table">
                                                <thead>
                                                    <tr>
                                                        <th>Domain</th>
                                                        <th>Subdomains</th>
                                                        <th>Status</th>
                                                        <th>Actions</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    ${domains.map((domain, index) => `
                                                        <tr>
                                                            <td><strong>${domain.domain}</strong></td>
                                                            <td>
                                                                <div class="d-flex flex-wrap gap-1">
                                                                    ${domain.subdomains.slice(0, 5).map(sub => 
                                                                        `<span class="badge bg-primary">${sub}</span>`
                                                                    ).join('')}
                                                                    ${domain.subdomains.length > 5 ? 
                                                                        `<span class="badge bg-secondary">+${domain.subdomains.length - 5} more</span>` : ''}
                                                                </div>
                                                            </td>
                                                            <td>
                                                                <span class="badge bg-${domain.active ? 'success' : 'secondary'}">
                                                                    ${domain.active ? 'Active' : 'Inactive'}
                                                                </span>
                                                            </td>
                                                            <td>
                                                                <button class="btn btn-sm btn-outline-primary" onclick="editDomain(${index})">
                                                                    <i class="fas fa-edit"></i> Edit
                                                                </button>
                                                                <button class="btn btn-sm btn-outline-${domain.active ? 'warning' : 'success'}" onclick="toggleDomain(${index})">
                                                                    <i class="fas fa-${domain.active ? 'pause' : 'play'}"></i> ${domain.active ? 'Disable' : 'Enable'}
                                                                </button>
                                                                <button class="btn btn-sm btn-outline-danger" onclick="deleteDomain(${index})">
                                                                    <i class="fas fa-trash"></i> Delete
                                                                </button>
                                                            </td>
                                                        </tr>
                                                    `).join('')}
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="card">
                                    <div class="card-header">
                                        <h6>🎯 How Random Subdomains Work</h6>
                                    </div>
                                    <div class="card-body">
                                        <p><strong>When enabled in campaigns:</strong></p>
                                        <ul class="list-unstyled">
                                            <li>📧 Email 1: <code>info@news.${domains[0]?.domain || 'yourdomain.com'}</code></li>
                                            <li>📧 Email 2: <code>team@marketing.${domains[0]?.domain || 'yourdomain.com'}</code></li>
                                            <li>📧 Email 3: <code>a247@updates.${domains[0]?.domain || 'yourdomain.com'}</code></li>
                                            <li>📧 Email 4: <code>support@alerts.${domains[0]?.domain || 'yourdomain.com'}</code></li>
                                        </ul>
                                        <small class="text-muted">Each email uses random username + random subdomain</small>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="card">
                                    <div class="card-header">
                                        <h6>⚙️ DNS Requirements</h6>
                                    </div>
                                    <div class="card-body">
                                        <p><strong>Required DNS Records:</strong></p>
                                        <div class="bg-light p-2 rounded">
                                            <code>Type: A<br>
Name: *<br>
Value: [Your Server IP]</code>
                                        </div>
                                        <small class="text-muted mt-2 d-block">This wildcard record enables all subdomains to work</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                }
                
                document.getElementById('pageContent').innerHTML = html;
                
            } catch (error) {
                document.getElementById('pageContent').innerHTML = '<div class="alert alert-danger">Error loading domains</div>';
            }
        }
        
        function showAddDomainModal() {
            // Create modal HTML if it doesn't exist
            if (!document.getElementById('addDomainModal')) {
                const modalHTML = `
                    <div class="modal fade" id="addDomainModal" tabindex="-1">
                        <div class="modal-dialog">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title">Add Sender Domain</h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                </div>
                                <div class="modal-body">
                                    <div class="mb-3">
                                        <label for="domainName" class="form-label">Domain Name</label>
                                        <input type="text" class="form-control" id="domainName" placeholder="yourdomain.com" required>
                                        <small class="text-muted">Enter your domain name (without http:// or www)</small>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Subdomains to Use</label>
                                        <div class="row">
                                            <div class="col-md-6">
                                                <div class="form-check">
                                                    <input class="form-check-input" type="checkbox" id="sub_mail" value="mail" checked>
                                                    <label class="form-check-label" for="sub_mail">mail</label>
                                                </div>
                                                <div class="form-check">
                                                    <input class="form-check-input" type="checkbox" id="sub_news" value="news" checked>
                                                    <label class="form-check-label" for="sub_news">news</label>
                                                </div>
                                                <div class="form-check">
                                                    <input class="form-check-input" type="checkbox" id="sub_marketing" value="marketing" checked>
                                                    <label class="form-check-label" for="sub_marketing">marketing</label>
                                                </div>
                                                <div class="form-check">
                                                    <input class="form-check-input" type="checkbox" id="sub_updates" value="updates" checked>
                                                    <label class="form-check-label" for="sub_updates">updates</label>
                                                </div>
                                            </div>
                                            <div class="col-md-6">
                                                <div class="form-check">
                                                    <input class="form-check-input" type="checkbox" id="sub_info" value="info" checked>
                                                    <label class="form-check-label" for="sub_info">info</label>
                                                </div>
                                                <div class="form-check">
                                                    <input class="form-check-input" type="checkbox" id="sub_support" value="support" checked>
                                                    <label class="form-check-label" for="sub_support">support</label>
                                                </div>
                                                <div class="form-check">
                                                    <input class="form-check-input" type="checkbox" id="sub_alerts" value="alerts" checked>
                                                    <label class="form-check-label" for="sub_alerts">alerts</label>
                                                </div>
                                                <div class="form-check">
                                                    <input class="form-check-input" type="checkbox" id="sub_newsletter" value="newsletter" checked>
                                                    <label class="form-check-label" for="sub_newsletter">newsletter</label>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="mb-3">
                                        <label for="customSubdomains" class="form-label">Custom Subdomains (Optional)</label>
                                        <input type="text" class="form-control" id="customSubdomains" placeholder="promo, deals, special">
                                        <small class="text-muted">Comma-separated list of additional subdomains</small>
                                    </div>
                                    <div class="mb-3">
                                        <div class="form-check form-switch">
                                            <input class="form-check-input" type="checkbox" id="domainActive" checked>
                                            <label class="form-check-label" for="domainActive">Enable this domain</label>
                                        </div>
                                    </div>
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                    <button type="button" class="btn btn-primary" onclick="saveDomain()">Add Domain</button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                document.body.insertAdjacentHTML('beforeend', modalHTML);
            }
            
            // Reset form
            document.getElementById('domainName').value = '';
            document.getElementById('customSubdomains').value = '';
            document.getElementById('domainActive').checked = true;
            
            // Check all default subdomains
            ['mail', 'news', 'marketing', 'updates', 'info', 'support', 'alerts', 'newsletter'].forEach(sub => {
                const checkbox = document.getElementById(`sub_${sub}`);
                if (checkbox) checkbox.checked = true;
            });
            
            new bootstrap.Modal(document.getElementById('addDomainModal')).show();
        }
        
        function saveDomain() {
            const domainName = document.getElementById('domainName').value.trim();
            const customSubdomains = document.getElementById('customSubdomains').value;
            const active = document.getElementById('domainActive').checked;
            
            if (!domainName) {
                showAlert('Please enter a domain name', 'danger');
                return;
            }
            
            // Validate domain format
            const domainRegex = /^[a-zA-Z0-9][a-zA-Z0-9-]{0,61}[a-zA-Z0-9]\.[a-zA-Z]{2,}$/;
            if (!domainRegex.test(domainName)) {
                showAlert('Please enter a valid domain name (e.g., yourdomain.com)', 'danger');
                return;
            }
            
            // Get selected subdomains
            const subdomains = [];
            ['mail', 'news', 'marketing', 'updates', 'info', 'support', 'alerts', 'newsletter'].forEach(sub => {
                const checkbox = document.getElementById(`sub_${sub}`);
                if (checkbox && checkbox.checked) {
                    subdomains.push(sub);
                }
            });
            
            // Add custom subdomains
            if (customSubdomains) {
                const customList = customSubdomains.split(',').map(s => s.trim()).filter(s => s);
                subdomains.push(...customList);
            }
            
            if (subdomains.length === 0) {
                showAlert('Please select at least one subdomain', 'danger');
                return;
            }
            
            // Load existing domains
            const domains = JSON.parse(localStorage.getItem('senderDomains') || '[]');
            
            // Check for duplicates
            if (domains.some(d => d.domain === domainName)) {
                showAlert('This domain already exists', 'danger');
                return;
            }
            
            // Add new domain
            domains.push({
                domain: domainName,
                subdomains: [...new Set(subdomains)], // Remove duplicates
                active: active,
                created: new Date().toISOString()
            });
            
            // Save to localStorage
            localStorage.setItem('senderDomains', JSON.stringify(domains));
            
            showAlert('Domain added successfully', 'success');
            bootstrap.Modal.getInstance(document.getElementById('addDomainModal')).hide();
            loadDomainsList();
        }
        
        function editDomain(index) {
            const domains = JSON.parse(localStorage.getItem('senderDomains') || '[]');
            const domain = domains[index];
            
            if (!domain) return;
            
            // Show modal with existing data
            showAddDomainModal();
            
            // Fill form with existing data
            document.getElementById('domainName').value = domain.domain;
            document.getElementById('domainActive').checked = domain.active;
            
            // Uncheck all first
            ['mail', 'news', 'marketing', 'updates', 'info', 'support', 'alerts', 'newsletter'].forEach(sub => {
                const checkbox = document.getElementById(`sub_${sub}`);
                if (checkbox) checkbox.checked = false;
            });
            
            // Check existing subdomains
            const standardSubs = ['mail', 'news', 'marketing', 'updates', 'info', 'support', 'alerts', 'newsletter'];
            const customSubs = [];
            
            domain.subdomains.forEach(sub => {
                if (standardSubs.includes(sub)) {
                    const checkbox = document.getElementById(`sub_${sub}`);
                    if (checkbox) checkbox.checked = true;
                } else {
                    customSubs.push(sub);
                }
            });
            
            document.getElementById('customSubdomains').value = customSubs.join(', ');
            
            // Change button text and function
            const saveButton = document.querySelector('#addDomainModal .btn-primary');
            saveButton.textContent = 'Update Domain';
            saveButton.onclick = () => updateDomain(index);
        }
        
        function updateDomain(index) {
            const domains = JSON.parse(localStorage.getItem('senderDomains') || '[]');
            
            const domainName = document.getElementById('domainName').value.trim();
            const customSubdomains = document.getElementById('customSubdomains').value;
            const active = document.getElementById('domainActive').checked;
            
            if (!domainName) {
                showAlert('Please enter a domain name', 'danger');
                return;
            }
            
            // Get selected subdomains
            const subdomains = [];
            ['mail', 'news', 'marketing', 'updates', 'info', 'support', 'alerts', 'newsletter'].forEach(sub => {
                const checkbox = document.getElementById(`sub_${sub}`);
                if (checkbox && checkbox.checked) {
                    subdomains.push(sub);
                }
            });
            
            // Add custom subdomains
            if (customSubdomains) {
                const customList = customSubdomains.split(',').map(s => s.trim()).filter(s => s);
                subdomains.push(...customList);
            }
            
            if (subdomains.length === 0) {
                showAlert('Please select at least one subdomain', 'danger');
                return;
            }
            
            // Update domain
            domains[index] = {
                ...domains[index],
                domain: domainName,
                subdomains: [...new Set(subdomains)],
                active: active,
                updated: new Date().toISOString()
            };
            
            localStorage.setItem('senderDomains', JSON.stringify(domains));
            
            showAlert('Domain updated successfully', 'success');
            bootstrap.Modal.getInstance(document.getElementById('addDomainModal')).hide();
            loadDomainsList();
        }
        
        function toggleDomain(index) {
            const domains = JSON.parse(localStorage.getItem('senderDomains') || '[]');
            
            if (domains[index]) {
                domains[index].active = !domains[index].active;
                localStorage.setItem('senderDomains', JSON.stringify(domains));
                
                showAlert(`Domain ${domains[index].active ? 'enabled' : 'disabled'} successfully`, 'success');
                loadDomainsList();
            }
        }
        
        function deleteDomain(index) {
            if (!confirm('Are you sure you want to delete this domain?')) return;
            
            const domains = JSON.parse(localStorage.getItem('senderDomains') || '[]');
            domains.splice(index, 1);
            localStorage.setItem('senderDomains', JSON.stringify(domains));
            
            showAlert('Domain deleted successfully', 'success');
            loadDomainsList();
        }
        
        // Function to get random subdomain for campaigns
        function getRandomSubdomain() {
            const domains = JSON.parse(localStorage.getItem('senderDomains') || '[]');
            const activeDomains = domains.filter(d => d.active);
            
            if (activeDomains.length === 0) {
                return null;
            }
            
            // Pick random active domain
            const randomDomain = activeDomains[Math.floor(Math.random() * activeDomains.length)];
            
            // Pick random subdomain from that domain
            const randomSubdomain = randomDomain.subdomains[Math.floor(Math.random() * randomDomain.subdomains.length)];
            
            // Generate random username
            const randomUsernames = [
                'info', 'news', 'updates', 'alerts', 'support', 'team', 'hello', 'contact',
                'marketing', 'sales', 'promo', 'deals', 'offers', 'newsletter', 'mail',
                'admin', 'service', 'help', 'welcome', 'notify', 'announce', 'bulletin'
            ];
            
            // Add some random alphanumeric usernames
            const alphanumeric = [
                'a' + Math.floor(Math.random() * 999),
                'x' + Math.floor(Math.random() * 999),
                'n' + Math.floor(Math.random() * 999),
                'm' + Math.floor(Math.random() * 999),
                'k' + Math.floor(Math.random() * 999)
            ];
            
            const allUsernames = [...randomUsernames, ...alphanumeric];
            const randomUsername = allUsernames[Math.floor(Math.random() * allUsernames.length)];
            
            return `${randomUsername}@${randomSubdomain}.${randomDomain.domain}`;
        }

        function loadAnalytics() {
            document.getElementById('pageTitle').textContent = 'System Health';
            document.getElementById('pageActions').innerHTML = '<button class="btn btn-primary" onclick="loadAnalytics()">Refresh Health Check</button>';
            
            // Load system health
            loadSystemHealth();
        }
        
        async function loadSystemHealth() {
            try {
                showWaterSplash('🏥 Running Health Checks...');
                const result = await api('/health');
                hideWaterSplash();
                const health = result.data;
                
                let html = '';
                
                // Overall status
                const statusColor = health.overall_status === 'healthy' ? 'success' : 
                                  health.overall_status === 'degraded' ? 'warning' : 'danger';
                const statusIcon = health.overall_status === 'healthy' ? '✅' : 
                                 health.overall_status === 'degraded' ? '⚠️' : '❌';
                
                html += `
                    <div class="alert alert-${statusColor}">
                        <h4>${statusIcon} System Status: ${health.overall_status.toUpperCase()}</h4>
                        <p>Last Check: ${health.timestamp}</p>
                    </div>
                `;
                
                // Health checks grid
                html += '<div class="row">';
                
                // Database check
                if (health.checks.database) {
                    const dbStatus = health.checks.database.status === 'healthy' ? 'success' : 'danger';
                    html += `
                        <div class="col-md-6 mb-3">
                            <div class="card">
                                <div class="card-header bg-${dbStatus} text-white">
                                    <h6>💾 Database Connection</h6>
                                </div>
                                <div class="card-body">
                                    <p>${health.checks.database.message}</p>
                                    ${health.checks.database.tables ? `
                                        <small class="text-muted">
                                            Tables: ${Object.keys(health.checks.database.tables).length} found
                                        </small>
                                    ` : ''}
                                </div>
                            </div>
                        </div>
                    `;
                }
                
                // SMTP Servers check
                if (health.checks.smtp_servers) {
                    const smtpStatus = health.checks.smtp_servers.status === 'healthy' ? 'success' : 
                                     health.checks.smtp_servers.status === 'warning' ? 'warning' : 'danger';
                    html += `
                        <div class="col-md-6 mb-3">
                            <div class="card">
                                <div class="card-header bg-${smtpStatus} text-white">
                                    <h6>📤 SMTP Servers</h6>
                                </div>
                                <div class="card-body">
                                    <p>${health.checks.smtp_servers.message}</p>
                                    ${health.checks.smtp_servers.summary ? `
                                        <div class="row text-center mt-2">
                                            <div class="col-4">
                                                <div class="text-success"><strong>${health.checks.smtp_servers.summary.healthy}</strong></div>
                                                <small>Healthy</small>
                                            </div>
                                            <div class="col-4">
                                                <div class="text-danger"><strong>${health.checks.smtp_servers.summary.unhealthy}</strong></div>
                                                <small>Unhealthy</small>
                                            </div>
                                            <div class="col-4">
                                                <div class="text-primary"><strong>${health.checks.smtp_servers.summary.total}</strong></div>
                                                <small>Total</small>
                                            </div>
                                        </div>
                                    ` : ''}
                                </div>
                            </div>
                        </div>
                    `;
                }
                
                // Proxies check
                if (health.checks.proxies) {
                    const proxyStatus = health.checks.proxies.status === 'healthy' ? 'success' : 
                                      health.checks.proxies.status === 'warning' ? 'warning' : 'danger';
                    html += `
                        <div class="col-md-6 mb-3">
                            <div class="card">
                                <div class="card-header bg-${proxyStatus} text-white">
                                    <h6>🔒 Proxy Servers</h6>
                                </div>
                                <div class="card-body">
                                    <p>${health.checks.proxies.message}</p>
                                    ${health.checks.proxies.summary ? `
                                        <div class="row text-center mt-2">
                                            <div class="col-4">
                                                <div class="text-success"><strong>${health.checks.proxies.summary.healthy}</strong></div>
                                                <small>Healthy</small>
                                            </div>
                                            <div class="col-4">
                                                <div class="text-danger"><strong>${health.checks.proxies.summary.unhealthy}</strong></div>
                                                <small>Unhealthy</small>
                                            </div>
                                            <div class="col-4">
                                                <div class="text-primary"><strong>${health.checks.proxies.summary.total}</strong></div>
                                                <small>Total</small>
                                            </div>
                                        </div>
                                    ` : ''}
                                </div>
                            </div>
                        </div>
                    `;
                }
                
                // IP Blacklist check
                if (health.checks.ip_blacklist) {
                    const ipStatus = health.checks.ip_blacklist.status === 'healthy' ? 'success' : 
                                   health.checks.ip_blacklist.status === 'warning' ? 'warning' : 'danger';
                    html += `
                        <div class="col-md-6 mb-3">
                            <div class="card">
                                <div class="card-header bg-${ipStatus} text-white">
                                    <h6>🛡️ IP Blacklist Status</h6>
                                </div>
                                <div class="card-body">
                                    <p>${health.checks.ip_blacklist.message}</p>
                                    ${health.checks.ip_blacklist.server_ip ? `
                                        <small class="text-muted">Server IP: ${health.checks.ip_blacklist.server_ip}</small>
                                    ` : ''}
                                    ${health.checks.ip_blacklist.blacklisted_on && health.checks.ip_blacklist.blacklisted_on.length > 0 ? `
                                        <div class="mt-2">
                                            <small class="text-danger">Blacklisted on: ${health.checks.ip_blacklist.blacklisted_on.join(', ')}</small>
                                        </div>
                                    ` : ''}
                                </div>
                            </div>
                        </div>
                    `;
                }
                
                // Mail Queue check
                if (health.checks.mail_queue) {
                    const queueStatus = health.checks.mail_queue.status === 'healthy' ? 'success' : 'warning';
                    html += `
                        <div class="col-md-6 mb-3">
                            <div class="card">
                                <div class="card-header bg-${queueStatus} text-white">
                                    <h6>📬 Mail Queue</h6>
                                </div>
                                <div class="card-body">
                                    <p>${health.checks.mail_queue.message}</p>
                                    ${health.checks.mail_queue.queue_size !== undefined ? `
                                        <div class="text-center mt-2">
                                            <div class="${health.checks.mail_queue.queue_size > 0 ? 'text-warning' : 'text-success'}"><strong>${health.checks.mail_queue.queue_size}</strong></div>
                                            <small>Emails in Queue</small>
                                        </div>
                                    ` : ''}
                                </div>
                            </div>
                        </div>
                    `;
                }
                
                // System Resources check
                if (health.checks.system_resources) {
                    const resourceStatus = health.checks.system_resources.status === 'healthy' ? 'success' : 
                                         health.checks.system_resources.status === 'warning' ? 'warning' : 'danger';
                    html += `
                        <div class="col-md-6 mb-3">
                            <div class="card">
                                <div class="card-header bg-${resourceStatus} text-white">
                                    <h6>💻 System Resources</h6>
                                </div>
                                <div class="card-body">
                                    <p>${health.checks.system_resources.message}</p>
                                    <div class="row text-center mt-2">
                                        <div class="col-6">
                                            <div class="text-primary"><strong>${health.checks.system_resources.disk_usage || 'N/A'}</strong></div>
                                            <small>Disk Usage</small>
                                        </div>
                                        <div class="col-6">
                                            <div class="text-primary"><strong>${health.checks.system_resources.memory_usage || 'N/A'}</strong></div>
                                            <small>Memory Usage</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                }
                
                // Data counts
                if (health.checks.data_counts && health.checks.data_counts.counts) {
                    html += `
                        <div class="col-md-12 mb-3">
                            <div class="card">
                                <div class="card-header bg-info text-white">
                                    <h6>📊 System Overview</h6>
                                </div>
                                <div class="card-body">
                                    <div class="row text-center">
                                        <div class="col-md-2">
                                            <div class="text-primary"><strong>${health.checks.data_counts.counts.campaigns || 0}</strong></div>
                                            <small>📧 Campaigns</small>
                                        </div>
                                        <div class="col-md-2">
                                            <div class="text-primary"><strong>${health.checks.data_counts.counts.lists || 0}</strong></div>
                                            <small>📋 Lists</small>
                                        </div>
                                        <div class="col-md-2">
                                            <div class="text-primary"><strong>${health.checks.data_counts.counts.contacts || 0}</strong></div>
                                            <small>👥 Contacts</small>
                                        </div>
                                        <div class="col-md-3">
                                            <div class="text-primary"><strong>${health.checks.data_counts.counts.smtp_servers || 0}</strong></div>
                                            <small>📤 SMTP Servers</small>
                                        </div>
                                        <div class="col-md-3">
                                            <div class="text-primary"><strong>${health.checks.data_counts.counts.proxies || 0}</strong></div>
                                            <small>🔒 Proxies</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                }
                
                html += '</div>';
                
                document.getElementById('pageContent').innerHTML = html;
                
            } catch (error) {
                hideWaterSplash();
                document.getElementById('pageContent').innerHTML = `
                    <div class="alert alert-danger">
                        <h4>❌ Health Check Failed</h4>
                        <p>Unable to perform system health check: ${error.message}</p>
                        <button class="btn btn-primary" onclick="loadSystemHealth()">Retry Health Check</button>
                    </div>
                `;
            }
        }

        function loadActivity() {
            document.getElementById('pageTitle').textContent = 'Live Activity Monitor';
            document.getElementById('pageActions').innerHTML = `
                <button class="btn btn-outline-primary btn-sm" onclick="refreshUnifiedActivity()">
                    <i class="fas fa-sync-alt"></i> Refresh
                </button>
                <button class="btn btn-outline-success btn-sm" onclick="toggleUnifiedAutoRefresh()" id="unifiedAutoRefreshBtn">
                    <i class="fas fa-play"></i> Auto Refresh
                </button>
                <button class="btn btn-outline-danger btn-sm" onclick="clearActivityLogs()">
                    <i class="fas fa-trash"></i> Clear Logs
                </button>
            `;
            
            // Load unified activity interface
            loadUnifiedActivityInterface();
        }
        
        // Unified Activity Interface Variables
        let unifiedAutoRefreshInterval = null;
        let isUnifiedAutoRefresh = false;
        
        async function loadUnifiedActivityInterface() {
            try {
                const html = `
                    <div class="container-fluid">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <div>
                                <span class="badge bg-success live-indicator me-3" style="animation: pulse 2s infinite;">🔴 LIVE
                                </span>
                                <small class="text-muted">Real-time campaign activity and delivery tracking</small>
                            </div>
                        </div>
                        
                        <!-- DELIVERY STATISTICS SECTION -->
                        <div class="row mb-4" id="unifiedDeliveryStats">
                            <div class="col-md-2">
                                <div class="card stat-card text-center bg-primary text-white" style="transition: all 0.3s;">
                                    <div class="card-body p-3">
                                        <i class="fas fa-paper-plane fa-2x mb-2"></i>
                                        <h6>Total Sent</h6>
                                        <h4 id="unifiedTotalSent">0</h4>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-2">
                                <div class="card stat-card text-center bg-success text-white" style="transition: all 0.3s;">
                                    <div class="card-body p-3">
                                        <i class="fas fa-check-circle fa-2x mb-2"></i>
                                        <h6>Delivered</h6>
                                        <h4 id="unifiedDelivered">0</h4>
                                        <small id="unifiedDeliveryRate">0%</small>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-2">
                                <div class="card stat-card text-center bg-info text-white" style="transition: all 0.3s;">
                                    <div class="card-body p-3">
                                        <i class="fas fa-inbox fa-2x mb-2"></i>
                                        <h6>Likely Inbox</h6>
                                        <h4 id="unifiedLikelyInbox">0</h4>
                                        <small id="unifiedInboxRate">0%</small>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-2">
                                <div class="card stat-card text-center bg-warning text-white" style="transition: all 0.3s;">
                                    <div class="card-body p-3">
                                        <i class="fas fa-exclamation-triangle fa-2x mb-2"></i>
                                        <h6>Likely Spam</h6>
                                        <h4 id="unifiedLikelySpam">0</h4>
                                        <small id="unifiedSpamRate">0%</small>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-2">
                                <div class="card stat-card text-center bg-secondary text-white" style="transition: all 0.3s;">
                                    <div class="card-body p-3">
                                        <i class="fas fa-star fa-2x mb-2"></i>
                                        <h6>Avg Quality</h6>
                                        <h4 id="unifiedAvgQuality">0</h4>
                                        <small>/100</small>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-2">
                                <div class="card stat-card text-center bg-dark text-white" style="transition: all 0.3s;">
                                    <div class="card-body p-3">
                                        <i class="fas fa-clock fa-2x mb-2"></i>
                                        <h6>Avg Time</h6>
                                        <h4 id="unifiedAvgTime">0</h4>
                                        <small>seconds</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- UNIFIED ACTIVITY FEED -->
                        <div class="card">
                            <div class="card-header">
                                <h5><i class="fas fa-stream me-2"></i>Live Activity Feed</h5>
                            </div>
                            <div class="card-body">
                                <div id="unifiedActivityFeed">
                                    <div class="text-center py-4">
                                        <i class="fas fa-spinner fa-spin fa-2x mb-3 text-primary"></i>
                                        <p class="text-muted">Loading live activity data...</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                document.getElementById('pageContent').innerHTML = html;
                
                // Load data
                refreshUnifiedActivity();
                
                // Auto-start refresh for live monitoring
                setTimeout(() => {
                    if (!isUnifiedAutoRefresh) {
                        toggleUnifiedAutoRefresh();
                    }
                }, 2000);
                
            } catch (error) {
                document.getElementById('pageContent').innerHTML = `
                    <div class="alert alert-danger">
                        <h4>Error Loading Activity Monitor</h4>
                        <p>${error.message}</p>
                        <button class="btn btn-primary" onclick="loadUnifiedActivityInterface()">Retry</button>
                    </div>
                `;
            }
        }
        
        async function loadUnifiedDeliveryStats() {
            try {
                // Get basic campaign stats since delivery-stats might not exist
                const campaigns = await api('/campaigns');
                let totalSent = 0, delivered = 0;
                
                if (campaigns.success && campaigns.data) {
                    campaigns.data.forEach(campaign => {
                        totalSent += campaign.sent_emails || 0;
                        if (campaign.status === 'completed') {
                            delivered += campaign.sent_emails || 0;
                        }
                    });
                }
                
                // Safely update elements if they exist
                const elements = {
                    'unifiedTotalSent': totalSent,
                    'unifiedDelivered': delivered,
                    'unifiedLikelyInbox': Math.round(delivered * 0.8), // Estimate
                    'unifiedLikelySpam': Math.round(delivered * 0.2), // Estimate
                    'unifiedAvgQuality': 85, // Default
                    'unifiedAvgTime': 2.5 // Default
                };
                
                Object.entries(elements).forEach(([id, value]) => {
                    const element = document.getElementById(id);
                    if (element) {
                        element.textContent = value;
                    }
                });
                
                // Update rates
                const total = totalSent || 1;
                const rateElements = {
                    'unifiedDeliveryRate': Math.round((delivered / total) * 100) + '%',
                    'unifiedInboxRate': '80%',
                    'unifiedSpamRate': '20%'
                };
                
                Object.entries(rateElements).forEach(([id, value]) => {
                    const element = document.getElementById(id);
                    if (element) {
                        element.textContent = value;
                    }
                });
                
            } catch (error) {
                console.error('Error loading delivery stats:', error);
            }
        }
        
        async function loadUnifiedActivityData() {
            try {
                // Load regular activity logs since enhanced-activity might not exist
                const result = await api('/activity?limit=50');
                if (result.success && result.data) {
                    // Convert regular activity to unified format
                    const unifiedLogs = result.data.map(log => ({
                        id: log.id,
                        type: 'activity',
                        username: log.campaign_name || 'System',
                        activity_type: log.action || 'Activity',
                        description: log.details || 'System activity',
                        created_at: log.timestamp || new Date().toISOString(),
                        status: log.status || 'info'
                    }));
                    displayUnifiedActivityData(unifiedLogs);
                } else {
                    const container = document.getElementById('unifiedActivityFeed');
                    if (container) {
                        container.innerHTML = '<div class="text-center py-4"><i class="fas fa-inbox fa-2x text-muted mb-2"></i><p class="text-muted">No activity found. Start by creating campaigns!</p></div>';
                    }
                }
            } catch (error) {
                console.error('Activity load error:', error);
                const container = document.getElementById('unifiedActivityFeed');
                if (container) {
                    container.innerHTML = '<div class="text-center py-4"><i class="fas fa-exclamation-triangle fa-2x text-warning mb-2"></i><p class="text-muted">Activity feed temporarily unavailable</p></div>';
                }
            }
        }
        
        function displayUnifiedActivityData(logs) {
            const container = document.getElementById('unifiedActivityFeed');
            
            // Check if container exists
            if (!container) {
                console.error('Activity feed container not found');
                return;
            }
            
            if (logs.length === 0) {
                container.innerHTML = '<div class="text-center py-4"><i class="fas fa-inbox fa-2x text-muted mb-2"></i><p class="text-muted">Waiting for email activity...</p></div>';
                return;
            }
            
            // Show only last 10 entries for live feed
            const recentLogs = logs.slice(0, 10);
            
            const html = recentLogs.map((log, index) => {
                const isDelivery = log.type === 'delivery';
                const iconClass = isDelivery ? 'fa-envelope' : 'fa-user';
                const cardClass = isDelivery ? 'border-left: 4px solid #0d6efd;' : 'border-left: 4px solid #6c757d;';
                const iconColor = isDelivery ? 'text-primary' : 'text-secondary';
                
                let statusBadge = '';
                let qualityInfo = '';
                let emailInfo = '';
                
                if (isDelivery) {
                    const statusColor = {
                        'delivered': 'success',
                        'rejected': 'danger',
                        'deferred': 'warning',
                        'bounced': 'danger'
                    }[log.delivery_status] || 'secondary';
                    
                    statusBadge = `<span class="badge bg-${statusColor}">${log.delivery_status || 'sent'}</span>`;
                    
                    if (log.quality_score) {
                        const qualityColor = log.quality_score >= 80 ? 'success' : log.quality_score >= 60 ? 'warning' : 'danger';
                        qualityInfo = `<span class="badge bg-${qualityColor} ms-2">${log.quality_score}/100</span>`;
                    }
                    
                    // Extract email from description if available
                    const emailMatch = log.description.match(/([a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,})/);
                    if (emailMatch) {
                        emailInfo = `<div class="text-primary fw-bold">📧 ${emailMatch[1]}</div>`;
                    }
                } else {
                    const activityColor = {
                        'success': 'success',
                        'error': 'danger',
                        'warning': 'warning'
                    }[log.status] || 'info';
                    statusBadge = `<span class="badge bg-${activityColor}">${log.activity_type}</span>`;
                }
                
                // Add animation for new entries
                const animationClass = index < 3 ? 'animate__animated animate__fadeInDown' : '';
                
                return `
                    <div class="card mb-2 ${animationClass}" style="${cardClass} transition: all 0.3s ease;" id="activity-${log.id || index}">
                        <div class="card-body p-2">
                            <div class="d-flex align-items-start">
                                <div class="me-2">
                                    <i class="fas ${iconClass} ${iconColor}"></i>
                                </div>
                                <div class="flex-grow-1">
                                    <div class="d-flex justify-content-between align-items-start">
                                        <div class="flex-grow-1">
                                            ${emailInfo}
                                            <small class="text-muted d-block">${log.description}</small>
                                            <small class="text-muted">
                                                <i class="fas fa-clock me-1"></i>${log.created_at}
                                                ${log.smtp_code ? ' • Code: ' + log.smtp_code : ''}
                                            </small>
                                        </div>
                                        <div class="text-end ms-2">
                                            ${statusBadge}
                                            ${qualityInfo}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
            
            container.innerHTML = html;
            
            // Auto-scroll to top for new entries
            container.scrollTop = 0;
        }
        
        function refreshUnifiedActivity() {
            loadUnifiedDeliveryStats();
            loadUnifiedActivityData();
        }
        
        function toggleUnifiedAutoRefresh() {
            const btn = document.getElementById('unifiedAutoRefreshBtn');
            
            if (isUnifiedAutoRefresh) {
                clearInterval(unifiedAutoRefreshInterval);
                btn.innerHTML = '<i class="fas fa-play"></i> Auto Refresh';
                btn.className = 'btn btn-outline-success btn-sm';
                isUnifiedAutoRefresh = false;
            } else {
                // Faster refresh for live monitoring (5 seconds)
                unifiedAutoRefreshInterval = setInterval(refreshUnifiedActivity, 5000);
                btn.innerHTML = '<i class="fas fa-pause"></i> Live Mode';
                btn.className = 'btn btn-success btn-sm';
                isUnifiedAutoRefresh = true;
            }
        }
        
        // Prevent page navigation during campaign sending
        let campaignSending = false;
        
        window.addEventListener('beforeunload', function(e) {
            if (campaignSending) {
                e.preventDefault();
                e.returnValue = 'Campaign is currently sending. Are you sure you want to leave?';
                return e.returnValue;
            }
        });
        
        // Override ALL navigation functions during sending
        const originalFunctions = {};
        const navigationFunctions = ['loadCampaigns', 'loadLists', 'loadSmtp', 'loadProxies', 'loadSpinner', 'loadTemplateManager', 'loadDelivery', 'loadSenderDomains', 'loadAnalytics', 'loadSettings'];
        
        navigationFunctions.forEach(funcName => {
            if (window[funcName]) {
                originalFunctions[funcName] = window[funcName];
                window[funcName] = function() {
                    if (campaignSending && funcName !== 'loadActivity') {
                        showAlert('⚠️ Campaign is sending. Please wait or go to Activity Log to monitor.', 'warning');
                        loadActivity(); // Force to activity log
                        return;
                    }
                    if (originalFunctions[funcName]) originalFunctions[funcName]();
                };
            }
        });
        
        // Set campaign sending state
        window.setCampaignSending = function(sending) {
            campaignSending = sending;
            if (sending) {
                showAlert('🔴 Campaign sending started - Stay on this page for live monitoring', 'info');
            }
        };
        
        async function clearActivityLogs() {
            if (!confirm('Are you sure you want to clear all activity logs? This action cannot be undone.')) {
                return;
            }
            
            try {
                const result = await apiWithLoading('/activity/clear', 'DELETE', null, 'Clearing activity logs...');
                
                if (result.success) {
                    showAlert('Activity logs cleared successfully!', 'success');
                    refreshUnifiedActivity(); // Reload unified activity
                } else {
                    showAlert('Error clearing logs: ' + result.message, 'danger');
                }
            } catch (error) {
                showAlert('Error clearing activity logs', 'danger');
            }
        }

        // Settings page
        function loadSettings() {
            document.getElementById('pageTitle').textContent = 'Settings';
            document.getElementById('pageActions').innerHTML = '';
            
            document.getElementById('pageContent').innerHTML = `
                <div class="row">
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header">
                                <h5>Account Settings</h5>
                            </div>
                            <div class="card-body">
                                <div class="mb-3">
                                    <label class="form-label">Username</label>
                                    <input type="text" class="form-control" id="settingsUsername" readonly>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Email</label>
                                    <input type="email" class="form-control" id="settingsEmail">
                                </div>
                                <button class="btn btn-primary" onclick="updateProfile()">Update Profile</button>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header">
                                <h5>Change Password</h5>
                            </div>
                            <div class="card-body">
                                <div class="mb-3">
                                    <label class="form-label">Current Password</label>
                                    <input type="password" class="form-control" id="currentPassword">
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">New Password</label>
                                    <input type="password" class="form-control" id="newPassword">
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Confirm New Password</label>
                                    <input type="password" class="form-control" id="confirmNewPassword">
                                </div>
                                <button class="btn btn-warning" onclick="changePassword()">Change Password</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            loadUserSettings();
        }
        
        // Load user settings
        async function loadUserSettings() {
            try {
                const result = await api('/me');
                if (result.success) {
                    document.getElementById('settingsUsername').value = result.user.username;
                    document.getElementById('settingsEmail').value = result.user.email || '';
                }
            } catch (error) {
                showAlert('Error loading user settings', 'danger');
            }
        }
        
        // Handle logout
        async function handleLogout() {
            if (confirm('Are you sure you want to logout?')) {
                try {
                    await api('/logout', 'POST');
                    window.location.href = 'login.html';
                } catch (error) {
                    window.location.href = 'login.html';
                }
            }
        }
        
        // Check authentication on page load
        async function checkAuth() {
            try {
                const result = await api('/me');
                if (result.success) {
                    document.getElementById('currentUsername').textContent = result.user.username;
                } else {
                    // Redirect to login if not authenticated
                    window.location.href = 'login.html';
                }
            } catch (error) {
                console.log('Auth check failed:', error);
                // Redirect to login if auth check fails
                window.location.href = 'login.html';
            }
        }
        
        // Campaign preview functions
        function previewCampaignContent() {
            const content = document.getElementById('composeBody').value;
            const subject = document.getElementById('composeSubject').value;
            const enableAutoSpin = document.getElementById('enableAutoSpin').checked;
            
            if (!content) {
                showAlert('Please enter message content to preview', 'warning');
                return;
            }
            
            // FIXED: Proper signature formatting function
            function formatSignatureForPreview(text) {
                console.log('Input text:', text);
                
                if (!text.includes('---')) {
                    return text.replace(/\n/g, '<br>');
                }
                
                // Find the first occurrence of ---
                const separatorIndex = text.indexOf('---');
                const mainContent = text.substring(0, separatorIndex).trim();
                const signatureContent = text.substring(separatorIndex + 3).trim();
                
                console.log('Main content:', mainContent);
                console.log('Signature content:', signatureContent);
                
                // Process signature lines
                const signatureLines = signatureContent
                    .split(/\r?\n/)
                    .map(line => line.trim())
                    .filter(line => line.length > 0);
                
                console.log('Signature lines:', signatureLines);
                
                const mainFormatted = mainContent.replace(/\n/g, '<br>');
                const signatureFormatted = signatureLines.join('<br>');
                
                return `${mainFormatted}<br><br><hr style="border:1px solid #ddd;margin:10px 0;"><div style="font-weight:normal;">${signatureFormatted}</div>`;
            }
            
            // Generate 2 variations
            let previewHtml = '<div class="row">';
            
            for (let i = 1; i <= 2; i++) {
                let previewContent = content;
                let previewSubject = subject;
                
                if (enableAutoSpin) {
                    previewContent = applyCampaignSpinning(content);
                    previewSubject = applyCampaignSpinning(subject);
                }
                
                // Replace variables
                previewContent = previewContent.replace(/{first_name}/g, 'John');
                previewContent = previewContent.replace(/{last_name}/g, 'Smith');
                previewContent = previewContent.replace(/{email}/g, 'john.smith@example.com');
                
                previewSubject = previewSubject.replace(/{first_name}/g, 'John');
                previewSubject = previewSubject.replace(/{last_name}/g, 'Smith');
                previewSubject = previewSubject.replace(/{email}/g, 'john.smith@example.com');
                
                // Format with proper signature
                const formattedContent = formatSignatureForPreview(previewContent);
                
                previewHtml += `
                    <div class="col-md-6">
                        <div class="card mb-2">
                            <div class="card-header py-2 bg-light">
                                <small><strong>📧 Variation ${i}</strong></small>
                            </div>
                            <div class="card-body py-3">
                                ${previewSubject ? `<div class="mb-3"><strong>Subject:</strong> ${previewSubject}</div>` : ''}
                                <div style="font-size: 0.9em; line-height: 1.4; max-height: 250px; overflow-y: auto; border: 1px solid #eee; padding: 10px; background: #fafafa;">${formattedContent}</div>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            previewHtml += '</div>';
            
            document.getElementById('campaignPreviewContent').innerHTML = previewHtml;
            document.getElementById('campaignPreview').style.display = 'block';
        }
        
        function applyCampaignSpinning(text) {
            if (!text) return text;
            
            const autoSpinWords = {
                'good': ['good', 'great', 'excellent', 'wonderful'],
                'great': ['great', 'excellent', 'wonderful', 'fantastic'],
                'hello': ['hello', 'hi', 'hey', 'greetings'],
                'day': ['day', 'time', 'moment'],
                'try': ['try', 'attempt', 'work'],
                'friend': ['friend', 'buddy', 'pal'],
                'started': ['started', 'begun', 'initiated'],
                'today': ['today', 'now', 'currently'],
                'another': ['another', 'a new', 'one more'],
                'give': ['give', 'offer', 'provide'],
                'dreams': ['dreams', 'goals', 'aspirations'],
                'never': ['never', 'don\'t', 'won\'t'],
                'again': ['again', 'once more', 'another time']
            };
            
            // Process manual spinning first
            let processed = text.replace(/\{([^{}]*\|[^{}]*)\}/g, function(match, content) {
                const options = content.split('|');
                return options[Math.floor(Math.random() * options.length)].trim();
            });
            
            // Apply auto-spinning (50% chance)
            const words = processed.split(' ');
            for (let i = 0; i < words.length; i++) {
                if (Math.random() < 0.5) {
                    const cleanWord = words[i].replace(/[^a-zA-Z]/g, '').toLowerCase();
                    if (autoSpinWords[cleanWord]) {
                        const replacement = autoSpinWords[cleanWord][Math.floor(Math.random() * autoSpinWords[cleanWord].length)];
                        const punctuation = words[i].replace(/[a-zA-Z]/g, '');
                        words[i] = (words[i][0] === words[i][0].toUpperCase() ? 
                            replacement.charAt(0).toUpperCase() + replacement.slice(1) : replacement) + punctuation;
                    }
                }
            }
            
            return words.join(' ');
        }
        
        function updateCampaignPreview() {
            // Auto-hide preview when content changes
            document.getElementById('campaignPreview').style.display = 'none';
        }
        
        // Load dashboard on page load
        document.addEventListener('DOMContentLoaded', function() {
            checkAuth();
            loadDashboard();
        });
    </script>
</body>
</html>